!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("moment"),require("decimal.js")):"function"==typeof define&&define.amd?define(["moment","decimal.js"],t):e.ExprManager=t(e.moment,e.Decimal)}(this,function(i,t){"use strict";function g(e){return null===e?"null":Object.prototype.toString.call(e).replace("[object ","").replace("]","").toLowerCase()}function s(e){return"object"===g(e)}function l(e){return"array"===g(e)}function p(e,t){return 0<=(e+",").indexOf(t+",")}function d(e){return 0<="0123456789.".indexOf(e)}function T(e){return 0<="01234567".indexOf(e)}function _(e){return 0<="0123456789abcdefABCDEF".indexOf(e)}function b(e){return"."!==e&&d(e)||0<="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ$_".indexOf(e)}function V(e){var t=e.parent;return!(t&&(p("VTK_FUNCTION,TK_COLON",t.tokenType)&&t.childs[0]===e||"TK_DOT"===t.tokenType&&t.childs[0]!==e))}function n(e,t){return e&&"VTK_COMMA"===e.tokenType&&e.parent&&"VTK_PAREN"===e.parent.tokenType&&e.parent.parent&&"TK_IDEN"===e.parent.parent.tokenType&&e.parent.parent.tokenValue===t}function h(e,t,n){for(var r=!0,a=0,i=e.childs||[];a<i.length;a++){if(!1===h(i[a],t,n)){r=!1;break}}return r?t.call(n,e):r}function v(e){for(var n=[],t=1;t<arguments.length;t++)n[t-1]=arguments[t];return e.replace(/\{(\d+)\}/g,function(e,t){return n[t]})}function c(e,t){return JSON.stringify(e)===JSON.stringify(t)}function E(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e}i=i&&i.hasOwnProperty("default")?i.default:i,t=t&&t.hasOwnProperty("default")?t.default:t;var e={FieldDisplayName:{fn:function(e){return e.getContextVariableValue("FieldDisplayName")},p:[],r:"string"},FieldName:{fn:function(e){return e.getContextVariableValue("FieldName")},p:[],r:"string"},FieldValue:{fn:function(e){return e.getContextVariableValue("FieldValue")},p:[],r:"undefined"},IIf:{fn:function(e,t,n,r,a){return e.genValue(n?r:a)},p:["boolean","undefined","undefined"],r:"undefined"},IfNull:{fn:function(e,t,n,r){return e.genValue(null!==n?n:r)},p:["undefined","undefined"],r:"undefined"},Now:{fn:function(e){return e.genValue(new Date)},p:[],r:"date"},Parent:{e:"parent",fn:function(e){return e.getParentValue(null)},p:[],r:"object"},PropValue:{fn:function(e,t,n,r,a){var i,o=n;if("string"===g(a)&&l(o)){i="";for(var u=0;u<o.length;u++)i+=s(o[u])?o[u][r]:"",u<o.length-1&&(i+=a)}else l(o)&&(o=0<o.length?o[0]:{}),i=s(o)?o[r]:null;return void 0===i&&(i=null),e.genValue(i)},p:["undefined","string","string?"],r:"undefined"},Random:{fn:function(e){return e.genValue(Math.random())},p:[],r:"number"},RecNo:{e:"value",fn:function(e){return e.getRecNo(null)},p:[],r:"number"},Root:{e:"root",fn:function(e){return e.getRootValue()},p:[],r:"object"}};function u(e,t,n){var r,a="";if(e.isEntity()){for(var i={},o=e.parentObj;o;)""===o.entity.name||i[o.entity.name]||(i[o.entity.name]=o.entity.recNo),o=o.parentObj;for(var u in i)i.hasOwnProperty(u)&&this.pushEntityCurrent(u,i[u]);for(var s=e.entity.map,l=0;l<s.length&&""===(a=(r=this.calcEntityExpr(t,e.entity.name,s[l])).errorMsg);l++){var p=n.call(this,r,l);if(void 0!==p){a=p;break}}for(var u in i)i.hasOwnProperty(u)&&this.popEntityCurrent()}else for(var h=0;h<e.value.length&&""===(a=(r=this.calcDataExpr(t,e.value[h])).errorMsg);h++){var c=n.call(this,r,h);if(void 0!==c){a=c;break}}return a}function o(e,t,n){var r,a,i=this;return""!==(a=u.call(this,e,t,function(e){if(r){var t=n.call(i,r,e);if(t.errorMsg)return t.errorMsg;r=t}else r=e}))&&(r=this.genErrorValue(a)),r||(r=this.genValue(null)),r}var r,a,y,f={Average:{e:"value",fn:function(e,t,n){var r=o.call(e,t,n=n||"$0",function(e,t){return e.add(t)});if(""===r.errorMsg)if(null===r.toValue())r=e.genValue(0);else{var a=t.toValue().length;r=r.divide(e.genValue(a))}return r},p:["expr?"],r:"number"},Count:{e:"value",fn:function(e,t){var n=t.toValue().length;return e.genValue(n,void 0,null,"")},p:[],r:"number"},Distinct:{e:"data",fn:function(r,a,e){e=e||"$0";var i=r.genValue([],"array"),o=[];a.entity&&(i.entity=r.genEntityInfo(a.entity.fullName),i.entity.map=[],i.parentObj=a.parentObj);var t=u.call(r,a,e,function(e,t){var n=e.toValue();(function(e){for(var t=!1,n=0,r=o;n<r.length&&!(t=c(r[n],e));n++);return t})(n)||(o.push(n),i.arrayPush(a.subscript(r.genValue(t))),i.entity&&i.entity.map&&i.entity.map.push(a.entity.map[t]))});return""!==t&&(i=r.genErrorValue(t)),i},p:["expr?"],r:"array"},Max:{e:"value",fn:function(e,t,n){return o.call(e,t,n=n||"$0",function(e,t){var n=e.compare(t,">");return""===n.errorMsg&&(n=n.toValue()?e:t),n})},p:["expr?"],r:"undefined"},Min:{e:"value",fn:function(e,t,n){return o.call(e,t,n=n||"$0",function(e,t){var n=e.compare(t,"<");return""===n.errorMsg&&(n=n.toValue()?e:t),n})},p:["expr?"],r:"undefined"},Sum:{e:"value",fn:function(e,t,n){return o.call(e,t,n=n||"$0",function(e,t){return e.add(t)})},p:["expr?"],r:"undefined"},Where:{e:"data",fn:function(n,r,e){e=e||"true";var a=n.genValue([],"array");r.entity&&(a.entity=n.genEntityInfo(r.entity.fullName),a.entity.map=[],a.parentObj=r.parentObj);var t=u.call(n,r,e,function(e,t){e.toValue()&&(a.arrayPush(r.subscript(n.genValue(t))),a.entity&&a.entity.map&&a.entity.map.push(r.entity.map[t]))});return""!==t&&(a=n.genErrorValue(t)),a},p:["expr"],r:"array"}},k={ToString:{fn:function(e,t){return e.genValue(t.toValue()+"")},p:[],r:"string"}},m={DateOf:{fn:function(e,t){return e.genValue(i(t.toValue()).startOf("day").toDate())},p:[],r:"date"},DayOf:{fn:function(e,t){return e.genValue(i(t.toValue()).date())},p:[],r:"number"},DayOfWeek:{fn:function(e,t){return e.genValue(i(t.toValue()).day())},p:[],r:"number"},DaysBetween:{fn:function(e,t,n){return e.genValue(-i(t.toValue()).diff(n,"days"))},p:["date"],r:"number"},HourOf:{fn:function(e,t){return e.genValue(i(t.toValue()).hour())},p:[],r:"number"},HoursBetween:{fn:function(e,t,n){return e.genValue(-i(t.toValue()).diff(n,"hours"))},p:["date"],r:"number"},IncDay:{fn:function(e,t,n){return e.genValue(i(t.toValue()).add(n,"days").toDate())},p:["number"],r:"date"},IncHour:{fn:function(e,t,n){return e.genValue(i(t.toValue()).add(n,"hours").toDate())},p:["number"],r:"date"},IncMinute:{fn:function(e,t,n){return e.genValue(i(t.toValue()).add(n,"minutes").toDate())},p:["number"],r:"date"},IncMonth:{fn:function(e,t,n){return e.genValue(i(t.toValue()).add(n,"months").toDate())},p:["number"],r:"date"},IncSecond:{fn:function(e,t,n){return e.genValue(i(t.toValue()).add(n,"seconds").toDate())},p:["number"],r:"date"},IncWeek:{fn:function(e,t,n){return e.genValue(i(t.toValue()).add(n,"weeks").toDate())},p:["number"],r:"date"},IncYear:{fn:function(e,t,n){return e.genValue(i(t.toValue()).add(n,"years").toDate())},p:["number"],r:"date"},MilliSecondOf:{fn:function(e,t){return e.genValue(i(t.toValue()).millisecond())},p:[],r:"number"},MilliSecondsBetween:{fn:function(e,t,n){return e.genValue(-i(t.toValue()).diff(n,"milliseconds"))},p:["date"],r:"number"},MinuteOf:{fn:function(e,t){return e.genValue(i(t.toValue()).minute())},p:[],r:"number"},MinutesBetween:{fn:function(e,t,n){return e.genValue(-i(t.toValue()).diff(n,"minutes"))},p:["date"],r:"number"},MonthOf:{fn:function(e,t){return e.genValue(i(t.toValue()).month()+1)},p:[],r:"number"},MonthsBetween:{fn:function(e,t,n){return e.genValue(-i(t.toValue()).diff(n,"months"))},p:["date"],r:"number"},SecondOf:{fn:function(e,t){return e.genValue(i(t.toValue()).second())},p:[],r:"number"},SecondsBetween:{fn:function(e,t,n){return e.genValue(-i(t.toValue()).diff(n,"seconds"))},p:["date"],r:"number"},ToString:{fn:function(e,t,n){return e.genValue(i(t.toValue()).format(n||""))},p:["string?"],r:"string"},WeekOf:{fn:function(e,t){return e.genValue(i(t.toValue()).week())},p:[],r:"number"},WeeksBetween:{fn:function(e,t,n){return e.genValue(-i(t.toValue()).diff(n,"weeks"))},p:["date"],r:"number"},YearOf:{fn:function(e,t){return e.genValue(i(t.toValue()).year())},p:[],r:"number"},YearsBetween:{fn:function(e,t,n){return e.genValue(-i(t.toValue()).diff(n,"years"))},p:["date"],r:"number"}},N={Abs:{fn:function(e,t){return t.abs()},p:[],r:"number"},Ceil:{fn:function(e,t){return t.ceil()},p:[],r:"number"},Cos:{fn:function(e,t){return t.cos()},p:[],r:"number"},Exp:{fn:function(e,t){return t.exp()},p:[],r:"number"},Floor:{fn:function(e,t){return t.floor()},p:[],r:"number"},Ln:{fn:function(e,t){return t.ln()},p:[],r:"number"},Log:{fn:function(e,t,n){return t.log(n)},p:["number"],r:"number"},Power:{fn:function(e,t,n){return t.power(n)},p:["number"],r:"number"},Round:{fn:function(e,t,n){return t.round(n)},p:["number"],r:"number"},Sin:{fn:function(e,t){return t.sin()},p:[],r:"number"},Sqrt:{fn:function(e,t){return t.sqrt()},p:[],r:"number"},Tan:{fn:function(e,t){return t.tan()},p:[],r:"number"},ToRMB:{fn:function(e,t,n,r){return e.genValue(function(e,t,n){var r=(n?"零壹贰叁肆伍陆柒捌玖":"零一二三四五六七八九").split(""),a=[""].concat((n?"拾佰仟":"十百千").split("")),i=[""].concat("万亿兆".split("")),o=t?"元":"点",u="角分厘".split(""),s=t?"整":"",l="",p=(e+".").split(".",2),h=p[0].split(""),c=p[1].split(""),y="-"===h[0];y&&h.shift(),h=h.reverse();for(var f="",g=0,d=[],T=!0;g<h.length;)if(d.push(h[g++]),4===d.length||g===h.length){for(var _=0;_<d.length;_++){var b=Number(d[_]);T=0===b?(T||0===_||(f=r[0]+f),!0):(f=r[b]+a[_]+f,!1)}0===f.length?0<l.length&&l.split("")[0]!==r[0]&&(l=r[0]+l):l=f+(i[Math.floor((g-1)/4)]||"")+l,f="",d=[]}if(0<c.length){l+=o;for(var V=0;V<c.length;V++){var v=Number(c[V]);t?((0!==v||l.substring(l.length-1)!==r[0]||2<V)&&(l+=r[v]),(0!==v||l.substring(l.length-1)===r[0]&&2===V)&&(l+=u[V]||"")):l+=r[v]}}else 0===l.length&&(l=r[0]),t&&(l+=o+s);return t||l.substring(0,2)!==r[1]+a[1]||(l=l.substring(1)),l.split("")[0]===o&&(l=t?l.substring(1):r[0]+l),y&&(l="负"+l),l}(t.toValue(),void 0===n||n,void 0===r||r))},p:["boolean?","boolean?"],r:"string"},ToString:{fn:function(e,t){return e.genValue(t.toValue()+"")},p:[],r:"string"},Trunc:{fn:function(e,t,n){return t.trunc(n)},p:["number"],r:"number"}},M={Parent:{e:"parent",fn:function(e,t){return e.getParentValue(t)},p:[],r:"object"},RecNo:{e:"value",fn:function(e,t){return e.getRecNo(t)},p:[],r:"number"}},K=new(function(){function e(){this.localeName="en",this.locales={},this.functions={}}return e.prototype.defineLocale=function(e,t){null!==t?this.locales[e]=E(this.locales[e]||{},t):delete this.locales[e]},e.prototype.getLocale=function(e){return this.locales[e||this.localeName]},e.prototype.defineFunction=function(e,t){null!==t?this.functions[e]=E(this.functions[e]||{},t):delete this.functions[e]},e.prototype.getFunction=function(e){return this.functions[e||this.localeName]},e}()),S={"":e,array:f,boolean:k,date:m,number:N,object:M,string:{LeftString:{fn:function(e,t,n){return e.genValue(t.toValue().substring(0,n))},p:["number"],r:"string"},Length:{fn:function(e,t){return e.genValue(t.toValue().length)},p:[],r:"number"},Lower:{fn:function(e,t){return e.genValue(t.toValue().toLowerCase())},p:[],r:"string"},Pos:{fn:function(e,t,n){return e.genValue(t.toValue().indexOf(n))},p:["string"],r:"number"},Replace:{fn:function(e,t,n,r,a){var i,o;void 0===a&&(a="g");var u=t.toValue(),s=0,l=n.length;if(/^m?g?i?$/.test(a))if(/g/.test(a))if(/i/.test(a))for(s=u.toUpperCase().indexOf(n.toUpperCase(),s);-1!==s;){o=u.split(""),p=(p=[s,l]).concat(r.split("")),Array.prototype.splice.apply(o,p),s=(u=o.join("")).toUpperCase().indexOf(n.toUpperCase(),s)}else for(s=u.indexOf(n,s);-1!==s;){var p;o=u.split(""),p=(p=[s,l]).concat(r.split("")),Array.prototype.splice.apply(o,p),s=(u=o.join("")).indexOf(n,s)}else/i/.test(a)?0<=(s=u.toUpperCase().indexOf(n.toUpperCase(),s))&&(o=u.split(""),p=(p=[s,l]).concat(r.split("")),Array.prototype.splice.apply(o,p),u=o.join("")):u=u.replace(n,r);else i=e.genErrorValue(v(K.getLocale().MSG_EF_MODEL,a));return i||(i=e.genValue(u)),i},p:["string","string","string?"],r:"string"},ReplaceReg:{fn:function(t,e,n,r,a){var i;void 0===a&&(a="g");var o,u=e.toValue();try{o=new RegExp(n,a)}catch(e){i=t.genErrorValue(v(K.getLocale().MSG_EF_MODEL,a))}return u=u.replace(o,r),i||(i=t.genValue(u)),i},p:["string","string","string?"],r:"string"},RightString:{fn:function(e,t,n){var r=t.toValue();return e.genValue(r.substring(r.length-n,r.length))},p:["number"],r:"string"},SubString:{fn:function(e,t,n,r){var a=t.toValue(),i=0<=n?n:a.toString().length+n,o=i+r;return o<i&&(o=i),e.genValue(a.substring(i,o))},p:["number","number"],r:"string"},ToDate:{fn:function(e,t,n){n=n||"";var r=t.toValue(),a=i(r,n);return a.isValid()?e.genValue(a.toDate()):e.genErrorValue(v(K.getLocale().MSG_EF_STR_TO_NUM,r,n))},p:["string?"],r:"date"},ToNumber:{fn:function(e,t){var n=Number(t.toValue());return isNaN(n)?e.genErrorValue(v(K.getLocale().MSG_EF_STR_TO_NUM,t.toValue())):e.genValue(n)},p:[],r:"number"},ToString:{fn:function(e,t){return e.genValue(t.toValue()+"")},p:[],r:"string"},Trim:{fn:function(e,t){return e.genValue(t.toValue().trim())},p:[],r:"string"},TrimLeft:{fn:function(e,t){return e.genValue(t.toValue().replace(/^\s+/g,""))},p:[],r:"string"},TrimRight:{fn:function(e,t){return e.genValue(t.toValue().replace(/\s+$/g,""))},p:[],r:"string"},Upper:{fn:function(e,t){return e.genValue(t.toValue().toUpperCase())},p:[],r:"string"}}},C=function(){function e(){this.values={}}return e.prototype.calc=function(e,t){var n,r=t.getParserInfo(e);if(""===r.errorMsg){var a=this.doCalc(r.rootToken,t);""===a?((n=this.values[r.rootToken.id]).tokens=r.tokens,n.rootToken=r.rootToken):n=t.genErrorValue(a)}else n=t.genErrorValue(r.errorMsg);return n},e.prototype.doCalc=function(e,t){for(var n,r,a,i,o,u=e,s=u.parent,l="",p=t.isIfNullToken(u),h=t.isIIfToken(u),c=0;c<u.childs.length&&""===(l=this.doCalc(u.childs[c],t));c++)if(0===c){if(n=u.childs[0],i=this.values[n.id],p&&null!==i.toValue())break;if(h&&!i.toValue())c++;else if("TK_OR"===u.tokenType&&!0===i.toValue()||"TK_AND"===u.tokenType&&(!1===i.toValue()||"null"===i.type))break}else if(1===c&&(r=u.childs[1],o=this.values[r.id],h))break;if(""===l){switch(u.tokenType){case"TK_STRING":a=t.genValue(u.tokenValue,"string");break;case"TK_NUMBER":a=t.genValue(u.tokenValue,"number");break;case"TK_BOOL":a=t.genValue("true"===u.tokenValue,"boolean");break;case"TK_NULL":a=t.genValue(null,"null");break;case"TK_IDEN":a=t.genValue(u.tokenValue,"string"),V(u)&&(a=a.getVariableValue(null));break;case"TK_UNARY":a=i.negative(u.tokenValue);break;case"TK_NOT":a=i.not();break;case"TK_MULTI":a=i.multiply(o);break;case"TK_DIV":a=i.divide(o);break;case"TK_MOD":a=i.remainder(o);break;case"TK_PLUS":a=i.add(o);break;case"TK_MINUS":a=i.subtract(o);break;case"TK_CO":case"TK_EO":a=i.compare(o,u.tokenValue);break;case"TK_AND":a=i.and(o);break;case"TK_OR":a=i.or(o);break;case"TK_COLON":a=i.hashItem(o);break;case"TK_DOT":switch(r.tokenType){case"VTK_FUNCTION":a=o.getFunctionValue(i);break;case"TK_IDEN":a=o.getVariableValue(i)}break;case"VTK_COMMA":a=t.genValue([],"array");for(var y=0,f=u.childs;y<f.length;y++){var g=f[y];i=this.values[g.id],a.arrayPush(i)}break;case"VTK_PAREN":a=0===u.childs.length?t.genValue([],"array"):s&&"TK_IDEN"===s.tokenType&&"VTK_COMMA"!==n.tokenType?t.genValue([],"array").arrayPush(i):i;break;case"VTK_ARRAY":a=t.genValue([],"array"),0<u.childs.length&&("VTK_COMMA"===n.tokenType?a.arrayConcat(i):a.arrayPush(i));break;case"VTK_OBJECT":a=t.genValue({},"object"),0<u.childs.length&&("VTK_COMMA"===n.tokenType?a.objectSetProperties(i):a.objectSetProperty(i));break;case"VTK_SUBSCRIPT":a=i.subscript(o);break;case"VTK_FUNCTION":a=s&&"TK_DOT"===s.tokenType&&s.childs[0]!==u?i.hashItem(o):i.hashItem(o).getFunctionValue(null)}""===(l=a.errorMsg)&&(this.values[u.id]=a)}return l},e}(),O=function(){function e(){this.types={}}return e.prototype.check=function(e,t){var n,a=this,r=t.getParserInfo(e);if(""===r.errorMsg){var i=this.doCheck(r.rootToken,t);if(""===i){(n=this.types[r.rootToken.id]).tokens=r.tokens,n.rootToken=r.rootToken;var u=[],s=function(e){if("array"===g(e))for(var t=0,n=e;t<n.length;t++){var r=n[t];s(r)}else{for(var a=!1,i=0,o=u;i<o.length;i++){if(a=(r=o[i])===e)break}a||u.push(e)}};h(n.rootToken,function(e){var t=a.types[e.id];if(t&&t.depends&&s(t.depends),t&&t.entity){var n=e.parent,r=n?a.types[n.id]:null;r&&r.entity||s(t.entity.fullName)}return!0},this),n.dependencies=u}else n=t.genErrorType(i)}else n=t.genErrorType(r.errorMsg);return n},e.prototype.doCheck=function(e,t){for(var n,r,a,i,o,u=e,s=u.parent,l="",p=0;p<u.childs.length&&""===(l=this.doCheck(u.childs[p],t));p++)0===p?(n=u.childs[0],i=this.types[n.id]):1===p&&(r=u.childs[1],o=this.types[r.id]);if(""===l){switch(u.tokenType){case"TK_STRING":a=t.genType("string","string",u.tokenValue);break;case"TK_NUMBER":a=t.genType("number","number",u.tokenValue);break;case"TK_BOOL":a=t.genType("boolean","boolean",u.tokenValue);break;case"TK_NULL":a=t.genType("null","null",u.tokenValue);break;case"TK_IDEN":a=t.genType("string","string",u.tokenValue),V(u)&&(a=a.getVariableType(null));break;case"TK_UNARY":a=i.negative(u.tokenValue);break;case"TK_NOT":a=i.not();break;case"TK_MULTI":a=i.multiply(o);break;case"TK_DIV":a=i.divide(o);break;case"TK_MOD":a=i.remainder(o);break;case"TK_PLUS":a=i.add(o);break;case"TK_MINUS":a=i.subtract(o);break;case"TK_CO":case"TK_EO":a=i.compare(o,u.tokenValue);break;case"TK_AND":a=i.and(o);break;case"TK_OR":a=i.or(o);break;case"TK_COLON":a=i.hashItem(o);break;case"TK_DOT":switch(r.tokenType){case"VTK_FUNCTION":a=o.getFunctionType(i);break;case"TK_IDEN":a=o.getVariableType(i)}break;case"VTK_COMMA":a=t.genType("array",[],[]);for(var h=0,c=u.childs;h<c.length;h++){var y=c[h];i=this.types[y.id],a.arrayPush(i)}break;case"VTK_PAREN":a=0===u.childs.length?t.genType("array",[],[]):s&&"TK_IDEN"===s.tokenType&&"VTK_COMMA"!==n.tokenType?t.genType("array",[],[]).arrayPush(i):i;break;case"VTK_ARRAY":a=t.genType("array",[],[]),0<u.childs.length&&("VTK_COMMA"===n.tokenType?a.arrayConcat(i):a.arrayPush(i));break;case"VTK_OBJECT":a=t.genType("object",{},{}),0<u.childs.length&&("VTK_COMMA"===n.tokenType?a.objectSetProperties(i):a.objectSetProperty(i));break;case"VTK_SUBSCRIPT":a=i.subscript(o);break;case"VTK_FUNCTION":a=s&&"TK_DOT"===s.tokenType&&s.childs[0]!==u?i.hashItem(o):i.hashItem(o).getFunctionType(null)}""===(l=a.errorMsg)&&(this.types[u.id]=a)}return l},e}(),x=function(){function e(){this.expr=[],this.index=0}return e.prototype.setExpr=function(e){return this.expr=e.split(""),this.index=0,this},e.prototype.nextToken=function(){for(var e,t=this.expr,n=this.index,r=!1;n<t.length&&" "===t[n];)n++;var a,i="",o="",u="",s=n+1;if(!(n<t.length))return null;switch(t[n]){case"[":case"]":case"{":case"}":case".":case"(":case")":case"*":case"/":case"%":case"+":case"-":case":":case",":switch(u=i=t[n++],i){case"[":o="TK_LA";break;case"]":o="TK_RA";break;case"{":o="TK_LO";break;case"}":o="TK_RO";break;case".":o="TK_DOT";break;case"(":o="TK_LP";break;case")":o="TK_RP";break;case"*":o="TK_MULTI";break;case"/":o="TK_DIV";break;case"%":o="TK_MOD";break;case"+":o="TK_PLUS";break;case"-":o="TK_MINUS";break;case":":o="TK_COLON";break;case",":o="TK_COMMA"}break;case"!":i=t[n++],o=n<t.length&&"="===t[n]?(i+=t[n++],"TK_EO"):"TK_NOT",u=i;break;case">":case"<":i=t[n++],n<t.length&&"="===t[n]&&(i+=t[n++]),u=i,o="TK_CO";break;case"=":i=t[n++],o=n<t.length&&"="===t[n]?(i+=t[n++],"TK_EO"):"TK_UNKNOWN",u=i;break;case"&":case"|":if(i=t[n++],n<t.length&&t[n]===i){switch(i){case"&":o="TK_AND";break;case"|":o="TK_OR"}i+=t[n++]}else o="TK_UNKNOWN";u=i;break;case"'":case'"':var l=t[n],p=[],h=!1;for(i+=t[n++];!r&&n<t.length;){if("\\"===t[n])switch(t[n+1]){case"\\":n++,p.push("\\");break;case"n":n++,p.push("\n");break;case"'":n++,p.push("'");break;case'"':n++,p.push('"');break;case"t":n++,p.push("\t");break;case"b":n++,p.push("\b");break;case"r":n++,p.push("\r");break;case"f":n++,p.push("\f");break;case"u":var c=t.join("").substring(n+2,n+6);_(t[n+2])&&_(t[n+3])&&_(t[n+4])&&_(t[n+5])?(p.push(String.fromCharCode(parseInt(c,16))),n+=5):(r=!0,e={tokenErrorMsg:v(K.getLocale().MSG_EL_SYNTAX_UC,"\\u"+c),tokenIndex:n,tokenType:"TK_STRING"});break;case"x":var y=t.join("").substring(n+2,n+4);_(t[n+2])&&_(t[n+3])?(p.push(String.fromCharCode(parseInt(y,16))),n+=3):(r=!0,e={tokenErrorMsg:v(K.getLocale().MSG_EL_SYNTAX_XN,"\\x"+y),tokenIndex:n,tokenType:"TK_STRING"});break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":var f=t.join("").substring(n+1,n+4);T(t[n+1])&&T(t[n+2])&&T(t[n+3])?(p.push(String.fromCharCode(parseInt(f,8))),n+=3):(r=!0,e={tokenErrorMsg:v(K.getLocale().MSG_EL_SYNTAX_ON,"\\"+f),tokenIndex:n,tokenType:"TK_STRING"});break;default:n++,p.push(t[n])}else{if(t[n]===l){h=!0;break}p.push(t[n])}n++}if(!r){if(!0!==h){r=!0,e={tokenErrorMsg:v(K.getLocale().MSG_EL_SYNTAX_S,i+p.join("")),tokenIndex:n,tokenType:"TK_STRING"};break}n++,u=i+=p.join("")+l,i=p.join(""),o="TK_STRING"}break;default:if(d(i=t[n++])){for(;n<t.length&&d(t[n])&&("."!==t[n]||d(t[n+1]));)i+=t[n++];o=i.replace(/[^\.]/g,"").length<=1?"TK_NUMBER":"TK_UNKNOWN"}else if(b(i)){for(;n<t.length&&b(t[n]);)i+=t[n++];switch(i){case"true":case"false":o="TK_BOOL";break;case"null":o="TK_NULL";break;default:o="TK_IDEN"}}else{for(;n<t.length&&!b(a=t[n])&&" ()[]{}!<>=+-&|*/%'\",.".indexOf(a)<0;)i+=t[n++];o="TK_UNKNOWN"}u=i}if("TK_PLUS"===o||"TK_MINUS"===o){for(var g=n-u.length-1;0<=g;){if(0<="({[+-*/%><=&|:,".indexOf(t[g])){o="TK_UNARY";break}if(" "!==t[g])break;g--}-1===g&&(o="TK_UNARY")}return this.index=n,r||(e={tokenIndex:s,tokenText:u,tokenType:o,tokenValue:i}),e},e}(),L="TK_UNKNOWN,TK_STRING,TK_NUMBER,TK_BOOL,TK_NULL,TK_IDEN,TK_DOT,TK_LP,TK_LA,TK_LO,TK_RP,TK_RA,TK_RO,TK_UNARY,TK_NOT,TK_MULTI,TK_DIV,TK_MOD,TK_PLUS,TK_MINUS,TK_CO,TK_EO,TK_AND,TK_OR,TK_COLON,TK_COMMA".split(","),I=function(e,n){var r={};return e.forEach(function(e,t){return r[e]="1"===n[t]}),r},P=I(L,"01111101110001100000000000".split("")),D=I(L,"01111100001110000000000000".split("")),A=(r=L,a="00000000000000000000000000,00000010101110011111111111,00000010001110011111111111,00000010001110011111111111,00000000001110011111111111,00000011101110011111111111,00000100000000000000000000,01111101111001100000000000,01111101110101100000000000,01111100000010000000000000,00000010101110011111111101,00000010101110011111111101,00000010111110011111111101,01111101110001100000000000,01111101110001100000000000,01111101110001100000000000,01111101110001100000000000,01111101110001100000000000,01111101110001100000000000,01111101110001100000000000,01111101110001100000000000,01111101110001100000000000,01111101110001100000000000,01111101110001100000000000,01111101110001100000000000,01111101110001100000000000".split(","),y={},r.forEach(function(e,t){return y[e]=I(r,a[t].split(""))}),y),R=function(){function e(){this.errorMsg="",this.tokens=[],this.rootToken=null,this.lexer=new x}return e.prototype.parser=function(e){return this.doInit(e),""===this.errorMsg&&(this.errorMsg=this.doDoublyLinkedList()),""===this.errorMsg&&(this.rootToken=this.doParser(this.tokens)),""===this.errorMsg&&this.rootToken&&(this.errorMsg=this.doCheckSyntax(this.rootToken)),this},e.prototype.doInit=function(e){e?(this.rootToken=null,this.tokens=[],this.errorMsg="",this.lexer.setExpr(e)):this.errorMsg=K.getLocale().MSG_EP_EMPTY},e.prototype.doCreateVirtualToken=function(e){var t="";switch(e){case"VTK_COMMA":t=",";break;case"VTK_PAREN":t="()";break;case"VTK_ARRAY":t="[]";break;case"VTK_OBJECT":t="{}";break;case"VTK_SUBSCRIPT":t="[n]";break;case"VTK_FUNCTION":t="Fn()"}return{childs:[],parent:null,tokenText:t,tokenType:e,tokenValue:t}},e.prototype.doDoublyLinkedList=function(){for(var e=this.lexer.nextToken(),t=this.tokens,n=[],r="";!r&&e;){if("TK_UNKNOWN"===e.tokenType){r=v(K.getLocale().MSG_EP_UNKNOWN,e.tokenText);break}if("TK_STRING"===e.tokenType&&e.tokenErrorMsg){r=e.tokenErrorMsg;break}if(e.parent=null,e.childs=[],this.tokens.push(e),1===t.length&&!P[e.tokenType]){r=v(K.getLocale().MSG_EP_LEXICAL_B,e.tokenText);break}if(1!==t.length&&!A[t[t.length-2].tokenType][e.tokenType]){r=v(K.getLocale().MSG_EP_LEXICAL_L,t[t.length-2].tokenText,e.tokenText);break}switch(e.tokenType){case"TK_LP":case"TK_LA":case"TK_LO":n.push(e);break;case"TK_RP":case"TK_RA":case"TK_RO":n.length?e.tokenType.replace("R","L")===n[n.length-1].tokenType?n.pop():r=v(K.getLocale().MSG_EP_MATCH,n[n.length-1].tokenText):r=v(K.getLocale().MSG_EP_MATCH,e.tokenText)}e=this.lexer.nextToken()}return r||D[t[t.length-1].tokenType]||(r=v(K.getLocale().MSG_EP_LEXICAL_E,t[t.length-1].tokenText)),!r&&n.length&&(r=v(K.getLocale().MSG_EP_MATCH,n[n.length-1].tokenText)),r},e.prototype.doParser=function(e){var t=null;return e&&!e.length?t:(t=this.doParser_0(e),t=this.doParser_1(t),t=this.doParser_2(t),t=this.doParser_3(t),t=this.doParser_4(t,"TK_MULTI,TK_DIV,TK_MOD"),t=this.doParser_4(t,"TK_PLUS,TK_MINUS"),t=this.doParser_4(t,"TK_CO"),t=this.doParser_4(t,"TK_EO"),t=this.doParser_4(t,"TK_AND"),t=this.doParser_4(t,"TK_OR"),t=this.doParser_4(t,"TK_COLON"),1<(t=this.doParser_5(t)).length&&(this.errorMsg=K.getLocale().MSG_EP_PARSER),t[0])},e.prototype.doCheckSyntax=function(e){var o,u="",s=0;return h(this.rootToken,function(e){switch(e.id=s++,o=e.tokenText,e.tokenType){case"TK_DOT":"TK_IDEN"!==e.childs[1].tokenType||p("VTK_FUNCTION,TK_IDEN,TK_DOT,VTK_SUBSCRIPT,VTK_PAREN,VTK_OBJECT",e.childs[0].tokenType)||(u=v(K.getLocale().MSG_EP_SYNTAX_D,e.childs[0].tokenText));break;case"TK_COLON":e.parent&&p("VTK_OBJECT,VTK_COMMA",e.parent.tokenType)?e.childs&&e.childs[0]&&e.childs[0].childs&&0<e.childs[0].childs.length&&(u=v(K.getLocale().MSG_EP_SYNTAX_E,o)):u=v(K.getLocale().MSG_EP_SYNTAX_P,o);break;case"VTK_COMMA":e.parent&&p("VTK_OBJECT,VTK_ARRAY,VTK_PAREN",e.parent.tokenType)||(u=v(K.getLocale().MSG_EP_SYNTAX_C,o));break;case"VTK_PAREN":(e.parent&&"TK_IDEN"!==e.parent.tokenType||!e.parent)&&(0===e.childs.length?u=v(K.getLocale().MSG_EP_SYNTAX_N,o):"VTK_COMMA"===e.childs[0].tokenType&&(u=v(K.getLocale().MSG_EP_SYNTAX_M,o)));break;case"VTK_ARRAY":if(e.childs&&0<e.childs.length&&"VTK_COMMA"===e.childs[0].tokenType){e.parent&&"VTK_SUBSCRIPT"===e.parent.tokenType&&e.parent.childs[0]!==e&&(u=v(K.getLocale().MSG_EP_SYNTAX_SUB,","));for(var t=0,n=e.childs[0].childs;t<n.length;t++){if("TK_COLON"===n[t].tokenType){u=v(K.getLocale().MSG_EP_SYNTAX_A,":");break}}}break;case"VTK_OBJECT":var r=void 0;if(e.childs&&(0===e.childs.length||p("TK_COLON,VTK_COMMA",e.childs[0].tokenType)))if(0<e.childs.length&&"VTK_COMMA"===e.childs[0].tokenType)for(var a=0,i=e.childs[0].childs;a<i.length;a++){if(!(r="TK_COLON"===i[a].tokenType))break}else r=!0;else r=!1;r||(u=K.getLocale().MSG_EP_SYNTAX_O)}if(""!==u)return!1},this),u},e.prototype.doParser_0=function(e){for(var t,n=[],r=0,a=[],i=0;i<e.length;){if(p("TK_LP,TK_LA,TK_LO",(t=e[i]).tokenType)?r++:p("TK_RP,TK_RA,TK_RO",t.tokenType)&&r--,0<r)a.push(t);else if(0<a.length){var o=a.shift(),u=void 0;switch(o.tokenType){case"TK_LP":u="VTK_PAREN";break;case"TK_LA":u="VTK_ARRAY";break;case"TK_LO":u="VTK_OBJECT"}(t=this.doCreateVirtualToken(u)).tokenIndex=o.tokenIndex;var s=this.doParser(a);s&&(t.childs.push(s),s.parent=t),n.push(t),a=[]}else n.push(t);i++}return n},e.prototype.doParser_1=function(e){for(var t,n,r=[],a=0;a<e.length;){if(t=e[a],n=e[a+1],"TK_IDEN"===t.tokenType&&n&&"VTK_PAREN"===n.tokenType){var i=this.doCreateVirtualToken("VTK_FUNCTION");i.tokenIndex=t.tokenIndex,i.childs.push(t),(t.parent=i).childs.push(n),n.parent=t,a++,r.push(i)}else r.push(t);a++}return r},e.prototype.doParser_2=function(e){for(var t,n,r=[],a=0;a<e.length;){if(t=e[a],(n=e[a+1])&&("TK_DOT"===n.tokenType||"VTK_ARRAY"===n.tokenType&&p("TK_IDEN,TK_STRING,VTK_PAREN,VTK_FUNCTION,VTK_ARRAY,VTK_OBJECT",t.tokenType))){do{switch(n.tokenType){case"TK_DOT":n.childs.push(t),t.parent=n,t=e[a+=2],n.childs.push(t),t.parent=n,t=n,n=e[a+1];break;case"VTK_ARRAY":var i=this.doCreateVirtualToken("VTK_SUBSCRIPT");i.childs.push(t),(t.parent=i).childs.push(n),t=n.parent=i,n=e[++a+1]}}while(n&&("TK_DOT"===n.tokenType||"VTK_ARRAY"===n.tokenType));r.push(t)}else r.push(t);a++}return r},e.prototype.doParser_3=function(e){for(var t,n=[],r=0;r<e.length;){if(p("TK_UNARY,TK_NOT",(t=e[r]).tokenType)){n.push(t);do{var a=e[++r];t.childs.push(a),a.parent=t,t=e[r]}while(p("TK_UNARY,TK_NOT",t.tokenType))}else n.push(t);r++}return n},e.prototype.doParser_4=function(e,t){for(var n,r,a=[],i=0;i<e.length;){if(n=e[i],(r=e[i+1])&&p(t,r.tokenType)){for(var o=void 0;;){if(r.childs.push(n),o=n.parent=r,n=e[i+=2],r=e[i+1],o.childs.push(n),n.parent=o,!r||!p(t,r.tokenType))break;n=o}a.push(o)}else a.push(n);i++}return a},e.prototype.doParser_5=function(e){for(var t,n,r=[],a=0;a<e.length;){if(t=e[a],(n=e[a+1])&&"TK_COMMA"===n.tokenType){var i=this.doCreateVirtualToken("VTK_COMMA");for(i.tokenIndex=n.tokenIndex;n&&"TK_COMMA"===n.tokenType;)i.childs.push(t),t.parent=i,t=e[a+=2],n=e[a+1];i.childs.push(t),t.parent=i,r.push(i)}else r.push(t);a++}return r},e}(),G=function(){function o(e,t,n,r,a,i,o){this.context=e,this.type=t||"undefined",this.info=n||t,this.data=r,this.entity=a||null,this.depends=i||null,this.errorMsg=(o||"").trim()}return o.prototype.genType=function(e,t,n,r,a,i){return new o(this.context,e,t,n,r,a,i)},o.prototype.genErrorType=function(e){return this.genType(void 0,void 0,void 0,void 0,void 0,e)},o.prototype.hasData=function(){return void 0!==this.data},o.prototype.arrayPush=function(e){return this.info.push(e.info),this.data.push(e.data),this},o.prototype.arrayConcat=function(e){return this.info=this.info.concat(e.info),this.data=this.data.concat(e.data),this},o.prototype.objectSetProperty=function(e){var t=e.info;this.info[t.key]=t.value;var n=e.data;return this.data[n.key]=n.value,this},o.prototype.objectSetProperties=function(e){for(var t=0,n=e.info;t<n.length;t++){var r=n[t];this.info[r.key]=r.value}for(var a=0,i=e.data;a<i.length;a++){r=i[a];this.data[r.key]=r.value}return this},o.prototype.negative=function(e){var t;return t="null"===this.type||"undefined"===this.type||"number"===this.type?this.genType("number"):(t="-"===e?K.getLocale().MSG_EX_NEGATIVE:K.getLocale().MSG_EX_POSITIVE,this.genErrorType(v(t,this.type)))},o.prototype.not=function(){return this.genType("boolean")},o.prototype.multiply=function(e){return"null"===this.type&&"null"===e.type?this.genType("null"):"number"!==this.type&&"null"!==this.type&&"undefined"!==this.type||"number"!==e.type&&"null"!==e.type&&"undefined"!==e.type?this.genErrorType(v(K.getLocale().MSG_EX_MULTIPLY,this.type,e.type)):this.genType("number")},o.prototype.divide=function(e){return"null"===this.type&&"null"===e.type?this.genType("null"):"number"!==this.type&&"null"!==this.type&&"undefined"!==this.type||"number"!==e.type&&"undefined"!==e.type&&"null"!==e.type?this.genErrorType(v(K.getLocale().MSG_EX_DIVIDE,this.type,e.type)):e.hasData()&&("null"===e.data||"number"===e.type&&0===Number(e.data))?this.genErrorType(v(K.getLocale().MSG_EX_DIVIDE_N,e.data)):this.genType("number")},o.prototype.remainder=function(e){return"null"===this.type&&"null"===e.type?this.genType("null"):"number"!==this.type&&"null"!==this.type&&"undefined"!==this.type||"number"!==e.type&&"undefined"!==e.type?this.genErrorType(v(K.getLocale().MSG_EX_REMAINDER,this.type,e.type)):e.hasData()&&("null"===e.data||"number"===e.type&&0===Number(e.data))?this.genErrorType(v(K.getLocale().MSG_EX_REMAINDER_N,e.data)):this.genType("number")},o.prototype.add=function(e){return"undefined"===this.type&&"undefined"===e.type?this.genType("undefined"):"null"===this.type&&"null"===e.type?this.genType("null"):"number"!==this.type&&"null"!==this.type&&"undefined"!==this.type||"number"!==e.type&&"null"!==e.type&&"undefined"!==e.type?"string"!==this.type&&"null"!==this.type&&"undefined"!==this.type||"string"!==e.type&&"null"!==e.type&&"undefined"!==e.type?"array"!==this.type&&"null"!==this.type&&"undefined"!==this.type||"array"!==e.type&&"null"!==e.type&&"undefined"!==e.type?this.genErrorType(v(K.getLocale().MSG_EX_ADD,this.type,e.type)):this.genType("array"):this.genType("string"):this.genType("number")},o.prototype.subtract=function(e){return"undefined"===this.type&&"undefined"===e.type?this.genType("undefined"):"null"===this.type&&"null"===e.type?this.genType("null"):"number"!==this.type&&"null"!==this.type&&"undefined"!==this.type||"number"!==e.type&&"null"!==e.type&&"undefined"!==e.type?"array"!==this.type&&"null"!==this.type&&"undefined"!==this.type||"array"!==e.type&&"null"!==e.type&&"undefined"!==e.type?this.genErrorType(v(K.getLocale().MSG_EX_SUBTRACT,this.type,e.type)):this.genType("array"):this.genType("number")},o.prototype.equal=function(e,t){var n,r="=="===t;return n="undefined"===this.type||"undefined"===e.type||"null"===this.type||"null"===e.type||this.type===e.type?this.genType("boolean"):(n=r?K.getLocale().MSG_EX_EQUAL:K.getLocale().MSG_EX_EQUAL_N,this.genErrorType(v(n,this.type,e.type)))},o.prototype.compare=function(e,t){if("=="===t||"!="===t)return this.equal(e,t);var n=void 0;if("undefined"===this.type||"undefined"===e.type||"null"===this.type||"null"===e.type||this.type===e.type&&("string"===e.type||"date"===e.type||"number"===e.type))n=this.genType("boolean");else{switch(t){case">":n=K.getLocale().MSG_EX_COMPARE_A;break;case"<":n=K.getLocale().MSG_EX_COMPARE_B;break;case">=":n=K.getLocale().MSG_EX_COMPARE_C;break;case"<=":n=K.getLocale().MSG_EX_COMPARE_D}n=this.genErrorType(v(n,this.type,e.type))}return n},o.prototype.and=function(e){return"undefined"===this.type||"undefined"===e.type||"null"===this.type||"null"===e.type||"boolean"===this.type&&"boolean"===e.type?this.genType("boolean"):this.genErrorType(v(K.getLocale().MSG_EX_AND,this.type,e.type))},o.prototype.or=function(e){return"undefined"===this.type||"undefined"===e.type||"null"===this.type||"null"===e.type||"boolean"===this.type&&"boolean"===e.type?this.genType("boolean"):this.genErrorType(v(K.getLocale().MSG_EX_OR,this.type,e.type))},o.prototype.subscript=function(e){var t;if(e.info&&1===e.info.length){var n=e.info[0];t="string"===this.type||"array"===this.type?"number"===n||"undefined"===n?"array"===this.type&&this.entity?this.context.getEntityType(this):"string"===this.type?this.genType("string"):this.genType("undefined"):this.genErrorType(v(K.getLocale().MSG_EX_SUBSCRIPT_T,n)):"object"===this.type?(t=this.genType("string","string",n)).getVariableType(this):"undefined"===this.type?this.genType("undefined"):this.genErrorType(v(K.getLocale().MSG_EX_SUBSCRIPT,this.type))}else t=this.genErrorType(v(K.getLocale().MSG_EX_SUBSCRIPT_N));return t},o.prototype.hashItem=function(e){return this.genType("object",{key:this.data,value:e.info},{key:this.data,value:e.data})},o.prototype.getVariableType=function(e){return e&&"object"!==e.type&&"undefined"!==e.type?this.genErrorType(v(K.getLocale().MSG_EX_DOT,e.type)):this.context.getVariableType(this.data,e)},o.prototype.getFunctionType=function(e){return this.context.getFunctionType(this.info.key,e,this.info.value,this.data.value)},o}(),U=function(e){return new t(e)},w=function(){function i(e,t,n,r,a,i){this.context=e,this.type=n||g(t),"number"===this.type&&(t+=""),this.value=t,this.entity=r||null,this.errorMsg=(a||"").trim(),this.parentObj=i||null}return i.prototype.genValue=function(e,t,n,r,a){return new i(this.context,e,t,n,r,a)},i.prototype.genErrorValue=function(e){return this.genValue(void 0,void 0,void 0,e,void 0)},i.prototype.toValue=function(){return"number"===this.type?Number(this.value):this.value},i.prototype.isEntity=function(){return null!=this.entity},i.prototype.arrayPush=function(e){return e=e||this.genValue(null),this.toValue().push(e.toValue()),this},i.prototype.arrayConcat=function(e){return this.value=this.toValue().concat(e.toValue()),this},i.prototype.objectSetProperty=function(e){var t=e.toValue();return this.value[t.key]=t.value,this},i.prototype.objectSetProperties=function(e){for(var t=0,n=e.toValue();t<n.length;t++){var r=n[t];this.value[r.key]=r.value}return this},i.prototype.negative=function(e){var t;if("null"===this.type)t=this.genValue("0","number");else if("number"===this.type)t="-"===e?U(this.value).times(U(-1)).toString():this.value,t=this.genValue(t,"number");else{var n="-"===e?K.getLocale().MSG_EX_NEGATIVE:K.getLocale().MSG_EX_POSITIVE;t=this.genErrorValue(v(n,this.type))}return t},i.prototype.not=function(){return"boolean"===this.type?this.genValue(!this.value,"boolean"):"string"===this.type&&""===this.value||"number"===this.type&&"0"===this.value||"null"===this.type?this.genValue(!0,"boolean"):this.genValue(!1,"boolean")},i.prototype.multiply=function(e){var t;if("null"===this.type&&"null"===e.type)t=this.genValue(null,"null");else if("number"!==this.type&&"null"!==this.type||"number"!==e.type&&"null"!==e.type)t=this.genErrorValue(v(K.getLocale().MSG_EX_MULTIPLY,this.type,e.type));else{var n=U(this.value||"0"),r=U(e.value||"0");t=this.genValue(n.times(r).toString(),"number")}return t},i.prototype.divide=function(e){var t;if("null"===this.type&&"null"===e.type)t=this.genValue(null,"null");else if("null"===e.type||"number"===e.type&&"0"===e.value)t=this.genErrorValue(v(K.getLocale().MSG_EX_DIVIDE_N,e.value));else if("number"!==this.type&&"null"!==this.type||"number"!==e.type)t=this.genErrorValue(v(K.getLocale().MSG_EX_DIVIDE,this.type,e.type));else{var n=U(this.value||"0"),r=U(e.value);t=this.genValue(n.div(r).toString(),"number")}return t},i.prototype.remainder=function(e){var t;if("null"===this.type&&"null"===e.type)t=this.genValue(null,"null");else if("null"===e.type||"number"===e.type&&"0"===e.value)t=this.genErrorValue(v(K.getLocale().MSG_EX_REMAINDER_N,e.value));else if("number"!==this.type&&"null"!==this.type||"number"!==e.type)t=this.genErrorValue(v(K.getLocale().MSG_EX_REMAINDER,this.type,e.type));else{var n=U(this.value||"0"),r=U(e.value);t=this.genValue(n.mod(r).toString(),"number")}return t},i.prototype.add=function(e){var t,n;return"null"===this.type&&"null"===e.type?this.genValue(null,"null"):"number"!==this.type&&"null"!==this.type||"number"!==e.type&&"null"!==e.type?"string"!==this.type&&"null"!==this.type||"string"!==e.type&&"null"!==e.type?"array"!==this.type&&"null"!==this.type||"array"!==e.type&&"null"!==e.type?this.genErrorValue(v(K.getLocale().MSG_EX_ADD,this.type,e.type)):(t=this.value||[],n=e.value||[],this.genValue(t.concat(n),"array")):(t=(t=this.toValue())||"",n=(n=e.toValue())||"",this.genValue(t+n,"string")):(t=U(this.value||"0"),n=U(e.value||"0"),this.genValue(t.plus(n).toString(),"number"))},i.prototype.subtract=function(e){var t,n,r;if("null"===this.type&&"null"===e.type)t=this.genValue(null,"null");else if("number"!==this.type&&"null"!==this.type||"number"!==e.type&&"null"!==e.type)if("array"!==this.type&&"null"!==this.type||"array"!==e.type&&"null"!==e.type)t=this.genErrorValue(v(K.getLocale().MSG_EX_SUBTRACT,this.type,e.type));else{n=this.value||[],r=e.value||[];for(var a=[],i=void 0,o=0,u=n;o<u.length;o++){var s=u[o];i=!1;for(var l=0,p=r;l<p.length;l++){if(i=c(s,p[l]))break}i||a.push(s)}t=this.genValue(a,"array")}else n=U(this.value||"0"),r=U(e.value||"0"),t=this.genValue(n.minus(r).toString(),"number");return t},i.prototype.equal=function(e,t){var n,r,a,i="=="===t;if("null"===this.type&&"null"===e.type)n=this.genValue(i,"boolean");else if("null"===this.type||"null"===e.type)n=this.genValue(!i,"boolean");else if("number"===this.type&&"number"===e.type){r=U(this.value),a=U(e.value);var o=r.equals(a);n=this.genValue(i?o:!o,"boolean")}else if(this.type===e.type){o=c(this.value,e.value);n=this.genValue(i?o:!o,"boolean")}else{o=i?K.getLocale().MSG_EX_EQUAL:K.getLocale().MSG_EX_EQUAL_N;n=this.genErrorValue(v(o,this.type,e.type))}return n},i.prototype.compare=function(e,t){if("=="===t||"!="===t)return this.equal(e,t);var n=void 0;if("string"!==this.type&&"null"!==this.type||"string"!==e.type&&"null"!==e.type)if("date"!==this.type&&"null"!==this.type||"date"!==e.type&&"null"!==e.type)if("number"!==this.type&&"null"!==this.type||"number"!==e.type&&"null"!==e.type){switch(t){case">":n=K.getLocale().MSG_EX_COMPARE_A;break;case"<":n=K.getLocale().MSG_EX_COMPARE_B;break;case">=":n=K.getLocale().MSG_EX_COMPARE_C;break;case"<=":n=K.getLocale().MSG_EX_COMPARE_D}n=this.genErrorValue(v(n,this.type,e.type))}else{var r,a=void 0;switch(a=U(this.value||"0"),r=U(e.value||"0"),t){case">":n=a.greaterThan(r);break;case"<":n=a.lessThan(r);break;case">=":n=a.greaterThanOrEqualTo(r);break;case"<=":n=a.lessThanOrEqualTo(r)}n=this.genValue(n,"boolean")}else{switch(n=this.value-e.value,t){case">":n=0<n;break;case"<":n=n<0;break;case">=":n=0<=n;break;case"<=":n=n<=0}n=this.genValue(n,"boolean")}else{switch(t){case">":n=this.value>e.value;break;case"<":n=this.value<e.value;break;case">=":n=this.value>=e.value;break;case"<=":n=this.value<=e.value}n=this.genValue(n,"boolean")}return n},i.prototype.and=function(e){return e?"boolean"!==this.type&&"null"!==this.type||"boolean"!==e.type&&"null"!==e.type?this.genErrorValue(v(K.getLocale().MSG_EX_AND,this.type,e.type)):this.genValue(!(!this.value||!e.value),"boolean"):this.genValue(!1,"boolean")},i.prototype.or=function(e){return e?"boolean"!==this.type&&"null"!==this.type||"boolean"!==e.type&&"null"!==e.type?this.genErrorValue(v(K.getLocale().MSG_EX_OR,this.type,e.type)):this.genValue(!(!this.value&&!e.value),"boolean"):this.genValue(!0,"boolean")},i.prototype.subscript=function(e){var t,n,r;return r="array"===e.type?g(n=e.toValue()[0]):(n=e.toValue(),e.type),t="string"===this.type||"array"===this.type?"number"===r?(t=this.toValue()).length>n&&0<=n&&0<t.length?"array"===this.type&&this.entity?this.context.getEntityValue(this,n):(t=t[n],this.genValue(t,g(t),null)):this.genErrorValue(v(K.getLocale().MSG_EX_SUBSCRIPT_U,this.type,n)):this.genErrorValue(v(K.getLocale().MSG_EX_SUBSCRIPT_T,r)):"object"===this.type?(t=this.genValue(n)).getVariableValue(this):this.genErrorValue(v(K.getLocale().MSG_EX_SUBSCRIPT,this.type))},i.prototype.hashItem=function(e){return this.genValue({key:this.toValue(),value:e.toValue()},"object")},i.prototype.getVariableValue=function(e){return e&&"object"!==e.type?this.genErrorValue(v(K.getLocale().MSG_EX_DOT,e.type)):this.context.getVariableValue(this.toValue(),e)},i.prototype.getFunctionValue=function(e){var t=this.toValue();return e&&null===e.value?this.genErrorValue(v(K.getLocale().MSG_EX_FUNC_NULL,t.key)):this.context.getFunctionValue(t.key,e,t.value)},i.prototype.abs=function(){var e=U(this.value);return this.genValue(e.abs().toString(),"number")},i.prototype.ceil=function(){var e=U(this.value);return this.genValue(e.ceil().toString(),"number")},i.prototype.floor=function(){var e=U(this.value);return this.genValue(e.floor().toString(),"number")},i.prototype.round=function(e){var t;return t=0<=e?(t=(t=U(this.value)).toDecimalPlaces(e,4),this.genValue(t.toString(),"number")):this.genErrorValue(v(K.getLocale().MSG_EX_ROUND,e.toString()))},i.prototype.trunc=function(e){var t;return t=0<=e?(t=(t=U(this.value)).toDecimalPlaces(e,1),this.genValue(t.toString(),"number")):this.genErrorValue(v(K.getLocale().MSG_EX_TRUNC,e.toString()))},i.prototype.cos=function(){var e=U(this.value);return e=e.cos(),this.genValue(e.toString(),"number")},i.prototype.exp=function(){var e=U(this.value);return e=e.exp(),this.genValue(e.toString(),"number")},i.prototype.ln=function(){var e=U(this.value);return e.greaterThan("0")?(e=e.ln(),this.genValue(e.toString(),"number")):this.genErrorValue(v(K.getLocale().MSG_EX_LN,e.toString()))},i.prototype.log=function(e){var t=U(this.value);return t.greaterThan("0")&&0<e&&1!==e?(t=t.log(e),this.genValue(t.toString(),"number")):this.genErrorValue(v(K.getLocale().MSG_EX_LOG,e.toString(),t.toString()))},i.prototype.power=function(e){var t=U(this.value);return t=t.pow(e),this.genValue(t.toString(),"number")},i.prototype.sin=function(){var e=U(this.value);return e=e.sin(),this.genValue(e.toString(),"number")},i.prototype.sqrt=function(){var e=U(this.value);return e=e.sqrt(),this.genValue(e.toString(),"number")},i.prototype.tan=function(){var e=U(this.value);return e=e.tan(),this.genValue(e.toString(),"number")},i}(),j=function(){function e(){this.exprCache={}}return e.prototype.getParserInfo=function(e){var t=this.exprCache[e];if(!t&&(t=(new R).parser(e),!(this.exprCache[e]=t).errorMsg)){var n=new O;t.errorMsg=n.check(e,this).errorMsg}return t},e.prototype.genValue=function(e,t,n,r,a){return new w(this,e,t,n,r,a)},e.prototype.genErrorValue=function(e){return this.genValue(void 0,void 0,void 0,e,void 0)},e.prototype.genType=function(e,t,n,r,a,i){return new G(this,e,t,n,r,a,i)},e.prototype.genErrorType=function(e){return this.genType(void 0,void 0,void 0,void 0,void 0,e)},e.prototype.getFunctionType=function(e,t,n,r){return this.doGetFunctionType(e,t,n,r)},e.prototype.getFunctionValue=function(e,t,n){return this.doGetFunctionValue(e,t,n)},e.prototype.getVariableType=function(e,t){return this.doGetVariableType(e,t)},e.prototype.getVariableValue=function(e,t){return this.doGetVariableValue(e,t)},e.prototype.getEntityType=function(e){return this.doGetEntityType(e)},e.prototype.getEntityValue=function(e,t){return this.doGetEntityValue(e,t)},e.prototype.isIfNullToken=function(e){return n(e,this.doGetIsIfNullTokenName())},e.prototype.isIIfToken=function(e){return n(e,this.doGetIsIIfTokenName())},e}(),X=function(){function e(){this.curr=[]}return e.prototype.setDataCursor=function(e){this.dataCursor=e},e.prototype.push=function(e){this.curr.unshift({pIndex:0,params:e})},e.prototype.pop=function(){this.curr.shift()},e.prototype.isValid=function(e){return 0<=e&&0<this.curr.length&&e<this.curr[0].params.length},e.prototype.isEntityData=function(e){var t=this.curr[0];return t.pIndex=e||0,t.params[t.pIndex].isEntityData},e.prototype.getEntityName=function(e){return this.isEntityData(e)?this.getData(e):""},e.prototype.getEntityDataCursor=function(e,t){for(var n=this.dataCursor[e],r=0;r<this.curr.length;r++){var a=this.curr[r];0===r&&(a.pIndex=t||0);var i=a.params[a.pIndex];if(i.isEntityData&&i.current===e){n=i.cursor;break}}return n},e.prototype.getData=function(e){var t=this.curr[0];t.pIndex=e||0;t.params[t.pIndex];return t.params[t.pIndex].current},e}(),F=function(e){function t(){e.apply(this,arguments),this.exprCurrent=new X,this.pageContext={$C:{}},this.contextVariables=[],this.functions={}}return function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}(t,e),t.prototype.doGetFunctionType=function(e,t,n,r){var a,i=null!==t?t.entity?t.entity.type:t.type:"",o=this.getFuncType(i,e,n);if(null===o)a=this.genErrorType(v(K.getLocale().MSG_EC_FUNC_P,"undefined"===i?"":i,e));else{var u=[];if(o.p)for(var s=r,l=0;l<o.p.length;l++)if("expr"===o.p[l]&&"string"===n[l]&&"string"===g(s[l])){var p=t&&t.entity?this.calcEntityDependencies(s[l],t.entity.fullName):this.calcDataDependencies(s[l]);if(""!==p.errorMsg){a=this.genErrorType(p.errorMsg);break}u=u.concat(p.dependencies)}if(!a){var h=null,c=void 0;switch(o.e){case"root":h="",c="object";break;case"parent":if(null===t||t.entity){var y=null===t?this.exprCurrent.getEntityName():t.entity.fullName;(h=this.getParentName(y))?c="object":a=this.genErrorType(v(K.getLocale().MSG_EC_FUNC_R,"Parent"))}else a=this.genErrorType(v(K.getLocale().MSG_EC_FUNC_E,"Parent"));break;case"data":case"value":var f=null;null===t?f=this.exprCurrent.getEntityName():t.entity&&(f=t.entity.fullName),null!==f&&("data"===o.e&&(h=f),u.push(f))}a||(null!==h&&(h=this.genEntityInfo(h,c)),0===u.length&&(u=null),a=this.genType(o.r,o.r,void 0,h,u))}}return a},t.prototype.doGetFunctionValue=function(e,t,n){for(var r=null!==t?t.entity?t.entity.type:t.type:"",a=[t].concat(n),i=[],o=0,u=n;o<u.length;o++){var s=u[o];i.push(g(s))}var l=this.getFunc(r,e,i);return l?l.fn.apply(this,[this].concat(a)):this.genErrorValue(v(K.getLocale().MSG_EC_FUNC_P,r,e))},t.prototype.doGetVariableType=function(e,t){var n,r;if(r=0,null===t&&"$"===e.split("")[0]&&("C"===(r=e.substr(1))?n=this.genType(g(this.pageContext.$C)):(r=Number(r),isNaN(r)?n=this.genErrorType(v(K.getLocale().MSG_EC_VARI_I,e)):this.exprCurrent.isValid(r)?e="":n=this.genErrorType(v(K.getLocale().MSG_EC_VARI_N,e)))),!n)if(this.exprCurrent.isEntityData(r)){var a=void 0,i=void 0;null===t?(a=this.genEntityInfo(this.getPropertyName(this.exprCurrent.getEntityName(r),e)))?i=""===e?"object":a.type:n=this.genErrorType(v(K.getLocale().MSG_EC_PROP_N,e)):i=t.entity&&(a=this.genEntityInfo(this.getPropertyName(t.entity.fullName,e)))?a.type:"undefined",n||(n=this.genType(i,i,e,a))}else n=this.genType("undefined");return n},t.prototype.doGetVariableValue=function(e,t){var n,r;if(r=0,null===t&&"$"===e.split("")[0]&&("C"===(r=e.substr(1))?n=this.genValue(this.pageContext.$C):(r=Number(r),e="")),!n){var a=void 0;if(this.exprCurrent.isEntityData(r)){var i=void 0,o=void 0;if(null===t?(i=this.genEntityInfo(this.getPropertyName(this.exprCurrent.getEntityName(r),e)))?(a=""!==i.field||""===e?this.getEntityData(i.name,r):this.getEntityData(this.getParentName(i.name),r),o=null):n=this.genErrorValue(v(K.getLocale().MSG_EC_PROP_N,e)):(a=t.toValue(),!t.entity||"object"===t.entity.type&&""!==t.entity.field?i=null:(i=this.genEntityInfo(this.getPropertyName(t.entity.fullName,e)))?""===i.field&&(o=t):n=this.genErrorValue(v(K.getLocale().MSG_EC_PROP_N,e))),!n&&(!a||null===t&&""===e||(a=a[e]),void 0===a&&(a=null),(n=this.genValue(a,null,i,"",o))&&"array"===n.type&&n.entity)){n.entity.map=[];for(var u=0;u<a.length;u++)n.entity.map.push(u)}}else{if(a=null===t?this.exprCurrent.getData(r):a=t.toValue(),null!==t||""!==e)switch(g(a)){case"object":case"array":case"string":a=a[e];break;default:n=this.genErrorValue(v(K.getLocale().MSG_EC_PROP_E,a,e))}n||(void 0===a&&(a=null),n=this.genValue(a))}}return n},t.prototype.doGetEntityType=function(e){var t=this.genEntityInfo(e.entity.fullName,"object");return this.genType("object","object",void 0,t,[t.fullName])},t.prototype.doGetEntityValue=function(e,t){var n=e.toValue()[t],r=this.genEntityInfo(e.entity.fullName,"object");r.recNo=e.entity.map[t];var a=e.parentObj;return this.genValue(n,g(n),r,"",a)},t.prototype.doGetIsIfNullTokenName=function(){return"IfNull"},t.prototype.doGetIsIIfTokenName=function(){return"IIf"},t.prototype.setDataCursor=function(e){this.exprCurrent.setDataCursor(e)},t.prototype.setPageContext=function(e){this.pageContext.$C=e},t.prototype.setDataContext=function(e){this.dataContext=e},t.prototype.setData=function(e){this.data=e},t.prototype.regFunction=function(e){for(var t in e)if(e.hasOwnProperty(t)){var n=e[t];for(var r in n)if(n.hasOwnProperty(r)){var a=t?t+"."+r:r;n[r].getLocale=function(e){return function(){return K.getFunction()[e]}}(a)}}return E(this.functions,e)},t.prototype.getFunction=function(){return this.functions},t.prototype.genEntityInfo=function(e,t){var n,r=[],a=[];if(""!==e){var i=e.split("."),o=i[0],u=this.dataContext;if(u&&o&&u[o]){var s=u[o];r.push(o);for(var l=1;l<i.length;l++)if(o=i[l],s.childs&&s.childs[o]&&0===a.length)r.push(o),s=s.childs[o];else{var p=a.join(".");if(""!==p&&(p+="."),p+=o,!s.fields||!s.fields[p])break;a.push(o),n=s.fields[p].type}}}var h={field:a.join("."),fullName:e,name:r.join("."),recNo:-1,type:n};return h.name===h.fullName?h.type="array":h.name+"."+h.field!==h.fullName&&(h=null),h&&t&&(h.type=t),h},t.prototype.getRootValue=function(){var e=this.genEntityInfo("","object");return e.recNo=0,this.genValue(this.data,"object",e,"")},t.prototype.getParentValue=function(e){var t;if(this.exprCurrent.isEntityData()){var n=void 0;if(null===e?n=this.exprCurrent.getEntityName():e.entity&&""===e.entity.field?e.parentObj&&this.getParentName(e.entity.fullName)?t=e.parentObj:n=e.entity.fullName:t=this.genErrorValue(v(K.getLocale().MSG_EC_FUNC_E,"Parent")),!t&&n){var r=this.genEntityInfo(this.getParentName(n),"object");r.recNo=this.exprCurrent.getEntityDataCursor(r.name);var a=this.getEntityData(r.name);t=this.genValue(a,void 0,r)}}return t||this.genValue(null)},t.prototype.getEntityData=function(e,t){var n=this.data;if(""!==e)for(var r=[],a=0,i=e.split(".");a<i.length;a++){var o=i[a];if(r.push(o),void 0===(n=(n=n[o])[this.exprCurrent.getEntityDataCursor(r.join("."),t)]))break}return n},t.prototype.getParentName=function(e){var t=e.split(".");return t.pop(),t.join(".")},t.prototype.getPropertyName=function(e,t){return e&&t?e+"."+t:e||t},t.prototype.getRecNo=function(e){var t;if(this.exprCurrent.isEntityData()){var n=void 0;if(null===e){n=this.exprCurrent.getEntityName();var r=this.exprCurrent.getEntityDataCursor(n);t=this.genValue(r)}else t=e.entity&&""===e.entity.field?this.genValue(e.entity.recNo):this.genErrorValue(v(K.getLocale().MSG_EC_FUNC_E,"RecNo"))}else t=this.genValue(-1);return t},t.prototype.findParams=function(e,t){for(var n=[],r=[],a=e.length,i=0;i<e.length;i++){var o=e[i];o.indexOf("?")===o.length-1&&(o=o.replace("?",""),a--),r.push(o),i<t.length&&n.push(o)}var u=t.length>=a&&t.length<=r.length;if(u)for(var s=0;s<n.length&&(u="undefined"===n[s]||"undefined"===t[s]||"null"===t[s]||n[s]===t[s]||n[s]===g(t[s])&&("array"===n[s]||"object"===n[s])||"expr"===n[s]&&"string"===t[s]);s++);return u||(n=null),n},t.prototype.getFunc=function(e,t,n){var r;if("undefined"===e){var a=void 0,i=[];for(var o in this.functions)this.functions.hasOwnProperty(o)&&(a=this.functions[o][t])&&null!==this.findParams(a.p,n)&&i.push(a);r=1<i.length?i:1===i.length?i[0]:null}else(r=this.functions[e][t])&&r.fn&&null!==this.findParams(r.p,n)||(r=null);return r},t.prototype.getFuncType=function(e,t,n){var r=null,a=this.getFunc(e,t,n);if("array"===g(a)){for(var i="",o=0,u=a;o<u.length;o++){var s=u[o];if(""===i)i=s.r;else if(s.r!==i){i="";break}}r={r:i||"undefined"}}else null!==a&&(r={e:a.e,p:this.findParams(a.p,n),r:a.r});return r},t.prototype.getContextVariableValue=function(e){var t,n=this.contextVariables;return 0<n.length&&(t=n[n.length-1][e]),void 0===t&&(t=null),this.genValue(t)},t.prototype.pushContextVariables=function(e){this.contextVariables.push(e)},t.prototype.popContextVariables=function(){this.contextVariables.pop()},t.prototype._calcExpr=function(e,t){this.exprCurrent.push(t);var n=(new C).calc(e,this);return this.exprCurrent.pop(),n},t.prototype.calcEntityExpr=function(e,t,n){return this._calcExpr(e,[{current:t,cursor:n,isEntityData:!0}])},t.prototype.calcDataExpr=function(e,t){return this._calcExpr(e,[{current:t,cursor:0,isEntityData:!1}])},t.prototype.calcDependencies=function(e,t){this.exprCurrent.push(t);var n=(new O).check(e,this);return this.exprCurrent.pop(),n},t.prototype.calcEntityDependencies=function(e,t){return this.calcDependencies(e,[{current:t,cursor:0,isEntityData:!0}])},t.prototype.calcDataDependencies=function(e){return this.calcDependencies(e,[{current:"",cursor:0,isEntityData:!1}])},t.prototype.pushEntityCurrent=function(e,t){this.exprCurrent.push([{current:e,cursor:t,isEntityData:!0}])},t.prototype.popEntityCurrent=function(){this.exprCurrent.pop()},t}(j),B=function(){function e(){this.list=[],this.cache={},this.sorted=!1}return e.prototype._doUpdateMode=function(e,t,n,r,a){for(var i=[{entityName:r,fullName:n,propertyName:a,type:t,updateMode:"Single",updateTarget:""}],o=0,u=e;o<u.length;o++){var s=u[o];this._doGetMode(i,s),i.push({entityName:s.entityName,fullName:s.fullName,propertyName:s.propertyName,type:"update",updateMode:s.updateMode,updateTarget:s.updateTarget})}},e.prototype._doGetMode=function(e,t){for(var n=[],r=0,a=e;r<a.length;r++)for(var i=a[r],o=0,u=t.dependencies;o<u.length;o++){var s=u[o];if(i.fullName===s){var l=!0,p=!1;if("update"===i.type){for(var h=!1,c=0,y=t.dependencies;c<y.length;c++){var f=y[c];if(h=0===i.fullName.indexOf(f+"."))break}i.entityName===t.entityName?h?n.push({updateMode:"All"}):n.push({updateMode:"Single"}):0===t.entityName.indexOf(i.entityName+".")?h?n.push({updateMode:"All"}):n.push({updateMode:"BranchUpdate",updateTarget:this._doGetUpdateTarget(i.entityName,t.entityName)}):0===i.entityName.indexOf(t.entityName+".")?(n.push({updateMode:"Single"}),p=!0):(n.push({updateMode:"All"}),l=!1)}else"remove"===i.type?i.entityName===t.entityName?n.push({updateMode:"All"}):0===t.entityName.indexOf(i.entityName+".")?n.push({updateMode:"BranchDelete",updateTarget:this._doGetUpdateTarget(i.entityName,t.entityName)}):0===i.entityName.indexOf(t.entityName+".")?(n.push({updateMode:"Single"}),p=!0):(n.push({updateMode:"All"}),l=!1):i.entityName===t.entityName?n.push({updateMode:"All"}):0===t.entityName.indexOf(i.entityName+".")?n.push({updateMode:"All"}):0===i.entityName.indexOf(t.entityName+".")?(n.push({updateMode:"Single"}),p=!0):(n.push({updateMode:"All"}),l=!1);l&&!p&&n.push({updateMode:i.updateMode,updateTarget:i.updateTarget})}}for(var g="Single",d="",T=0,_=n;T<_.length;T++){var b=_[T],V=b.updateMode,v=b.updateTarget||"";g!==V||"BranchDelete"!==g&&"BranchUpdate"!==g?"BranchDelete"===V||"Single"===g?(g=V,d=v):"BranchDelete"===g||"Single"===V||"All"===V&&(g=V,d=v):d.length>v.length&&(d=v)}t.updateMode=g,t.updateTarget=d},e.prototype._doGetUpdateTarget=function(e,t){var n=e.split("."),r=t.split(".");return n.push(r[n.length]),n.join(".")},e.prototype.reset=function(){this.list=[],this.cache={},this.sorted=!1},e.prototype.add=function(e,t,n,r,a,i){this.cache={},this.sorted=!1;for(var o=-1,u=0;u<this.list.length;u++){var s=this.list[u];if(s.expr===(e||"")&&s.entityName===(t||"")&&s.propertyName===(n||"")&&(s.types===r||c(s.types.sort(),r.sort()))&&s.callback===a&&s.scope===i){o=u;break}}-1===o&&this.list.push({callback:a,entityName:t||"",expr:e||"",fullName:n?t+"."+n:t||"",propertyName:n||"",scope:i,types:r})},e.prototype.remove=function(e,t,n,r,a,i){this.cache={},this.sorted=!1;for(var o=0;o<this.list.length;o++){var u=this.list[o];if(u.expr===(e||"")&&u.entityName===(t||"")&&u.propertyName===(n||"")&&(u.types===r||c(u.types.sort(),r.sort()))&&u.callback===a&&u.scope===i){this.list.splice(o,1);break}}},e.prototype.checkAndSort=function(e){this.cache={},this.sorted=!0;for(var t="",n=0,r=this.list;n<r.length;n++){if(!(d=r[n]).dependencies&&e){var a=e(d.expr,d.entityName);if(""!==(t=a.errorMsg)){t=v(K.getLocale().MSG_ES_PARSER,d.entityName,d.expr,t);break}d.dependencies=a.dependencies}}if(""===t){for(var l=[],p=[],h=function(e,t){for(var n=!1,r=0,a=e;r<a.length;r++){a[r]===t&&(n=!0)}return n},c=function(e,t){if(!h(t,e)){for(var n=0,r=l;n<r.length;n++){for(var a=r[n],i=!1,o=0,u=e.dependencies;o<u.length;o++){var s=u[o];if(i=a.fullName===s)break}i&&(t.push(e),c(a,t))}h(p,e)||p.push(e)}},i=0,o=this.list;i<o.length;i++){""!==(d=o[i]).fullName&&l.push(d)}for(var u=0,s=l;u<s.length;u++){var y=s[u];c(y,[])}for(var f=0,g=this.list;f<g.length;f++){var d;""===(d=g[f]).fullName&&p.push(d)}this.list=p}return t},e.prototype.getExprs=function(e,t,n){var r=n?t+"."+n:t,u="load"===e||"add"===e,a=r+"|"+e,i=this.sorted?this.cache[a]:[];if(!i){i=[];for(var s={},l={},p=[],o=0,h=this.list;o<h.length;o++){var c=h[o];c.types&&0<c.types.length?0<=c.types.indexOf(e)&&p.push(c):p.push(c)}var y=function(e,t){for(var n=0;n<p.length;n++)if(!0!==l[n]){l[n]=!0;var r=p[n],a=u&&r.entityName===t&&""!==r.entityName;if(!a&&r.dependencies)for(var i=0,o=r.dependencies;i<o.length;i++){if(a=o[i]===e)break}a&&!s[n]&&(s[n]=!0,y(r.fullName,t)),l[n]=!1}};y(r,r);for(var f=0;f<p.length;f++)s[f]&&i.push(E({},p[f]));this._doUpdateMode(i,e,r,t,n),this.cache[a]=i}return i},e}();return function(){function e(){this.exprContext=new F,this.exprList=new B,this.regFunction(S)}return e.prototype.init=function(e,t,n){return this.exprContext.setData(e),this.exprContext.setDataContext(t),this.exprContext.setPageContext(n||{}),this},e.prototype.regFunction=function(e){return this.exprContext.regFunction(e),this},e.prototype.getFunction=function(){return this.exprContext.getFunction()},e.prototype.resetExpression=function(){return this.exprList.reset(),this},e.prototype.addExpression=function(e,t,n,r,a,i){return this.exprList.add(e,t,n,r,a,i),this},e.prototype.removeExpression=function(e,t,n,r,a,i){return this.exprList.remove(e,t,n,r,a,i),this},e.prototype.getExpressionList=function(e,t,n){return this.exprList.getExprs(e,t,n)},e.prototype.checkAndSort=function(){return this.exprList.checkAndSort((n=this.exprContext,function(e,t){return n.calcEntityDependencies(e,t)}));var n},e.prototype.calcExpression=function(e,t){for(var n=0,r=this.getExpressionList(e,t.entityName,t.propertyName);n<r.length;n++){var a=r[n];(t.exprInfo=a).callback.call(a.scope,e,t)}return this},e.prototype.calcDependencies=function(e,t){return this.exprContext.calcEntityDependencies(e,t)},e.prototype.calcExpr=function(e,t,n,r){n=n||{},this.exprContext.setDataCursor(n),r&&this.exprContext.pushContextVariables(r);var a=this.exprContext.calcEntityExpr(e,t,n[t]);return r&&this.exprContext.popContextVariables(),a},e.prototype.calc=function(e,t){return this.exprContext.calcDataExpr(e,t)},e.locale=K,e}()});
