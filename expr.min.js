!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("moment"),require("decimal")):"function"==typeof define&&define.amd?define(["moment","decimal"],t):e.expr=t(e.moment,e.Decimal)}(this,function(e,t){"use strict";function n(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}function r(e,t){return(e+",").indexOf(t+",")>=0}function i(e){return"0123456789.".indexOf(e)>=0}function a(e){return"01234567".indexOf(e)>=0}function o(e){return"0123456789abcdefABCDEF".indexOf(e)>=0}function u(e){return"."!==e&&i(e)||"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ$_".indexOf(e)>=0}function s(e){return e.replace(/[^\.]/g,"").length<=1}function l(e){return!u(e)&&" ()[]{}!<>=+-&|*/%'\",.".indexOf(e)<0}function p(e){var t=e.parent;return!(t&&(r("VTK_FUNCTION,TK_COLON",t.tokenType)&&t.childs[0]===e||"TK_DOT"===t.tokenType&&t.childs[0]!==e))}function h(e,t){return e&&"VTK_COMMA"===e.tokenType&&e.parent&&"VTK_PAREN"===e.parent.tokenType&&e.parent.parent&&"TK_IDEN"===e.parent.parent.tokenType&&e.parent.parent.tokenValue===t}function c(e,t,n){var r=!0;if(e.childs)for(var i=0,a=e.childs;i<a.length;i++){var o=a[i];if(!1===c(o,t,n)){r=!1;break}}return r?t.call(n,e):r}function f(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];return e.replace(/\{(\d+)\}/g,function(e,n){return t[n]})}function y(e){return"array"===T(e)}function g(e){return"string"===T(e)}function d(e){return"object"===T(e)}function _(e){return"number"===T(e)}function T(e){return null===e?"null":Object.prototype.toString.call(e).replace("[object ","").replace("]","").toLowerCase()}function b(e,t,n){var r=!0;if(e.length!==t.length)r=!1;else for(var i=0;i<e.length;i++)if(!0===n){if(-1===t.indexOf(e[i])){r=!1;break}}else if(!V(e[i],t[i])){r=!1;break}return r}function v(e,t){var n=[],r=[],i=!0;for(var a in e)e.hasOwnProperty(a)&&n.push(a);for(var o in t)t.hasOwnProperty(o)&&r.push(o);if(b(n,r,!0)){for(var u in e)if(t.hasOwnProperty(u)&&!V(e[u],t[u])){i=!1;break}}else i=!1;return i}function V(e,t){if(null!==e&&null!==t&&void 0!==e&&void 0!==t){var n=typeof e;return n===typeof t&&("object"===n?e.constructor===Date&&t.constructor===Date?e.valueOf()===t.valueOf():e.constructor===Array&&t.constructor===Array?b(e,t,!1):e.constructor!==Array&&t.constructor!==Array&&v(e,t):e===t)}return e===t}function E(e,t){if(d(e)&&d(t))for(var n in t)t.hasOwnProperty(n)&&(e[n]&&d(e[n])?E(e[n],t[n]):e[n]=t[n]);return e}function m(e,t,n){var r,i="";if(e.isEntity()){for(var a={},o=e.parentObj;o;)""===o.entity.name||a[o.entity.name]||(a[o.entity.name]=o.entity.recNo),o=o.parentObj;for(var u in a)a.hasOwnProperty(u)&&this.pushEntityCurrent(u,a[u]);for(var s=e.entity.map,l=0;l<s.length&&(r=this.calcEntityExpr(t,e.entity.name,s[l]),""===(i=r.errorMsg));l++){var p=n.call(this,r,l);if(void 0!==p){i=p;break}}for(var u in a)a.hasOwnProperty(u)&&this.popEntityCurrent()}else for(var h=0;h<e.value.length&&(r=this.calcDataExpr(t,e.value[h]),""===(i=r.errorMsg));h++){var c=n.call(this,r,h);if(void 0!==c){i=c;break}}return i}function N(e,t,n){var r,i,a=this;return i=m.call(this,e,t,function(e){if(r){var t=n.call(a,r,e);if(t.errorMsg)return t.errorMsg;r=t}else r=e}),""!==i&&(r=this.genErrorValue(i)),r||(r=this.genValue(null)),r}e="default"in e?e.default:e,t="default"in t?t.default:t;var k={fn:function(e,t,n,r,i){return e.genValue(n?r:i)},p:["boolean","undefined","undefined"],r:"undefined"},M={fn:function(e,t,n,r){return e.genValue(null!==n?n:r)},p:["undefined","undefined"],r:"undefined"},S={e:"parent",fn:function(e){return e.getParentValue(null)},p:[],r:"object"},x={e:"value",fn:function(e){return e.getRecNo(null)},p:[],r:"number"},C={e:"root",fn:function(e){return e.getRootValue()},p:[],r:"object"},O={fn:function(e){return e.genValue(new Date)},p:[],r:"date"},L={fn:function(e){return e.getContextVariableValue("FieldName")},p:[],r:"string"},K={fn:function(e){return e.getContextVariableValue("FieldDisplayName")},p:[],r:"string"},P={fn:function(e){return e.getContextVariableValue("FieldValue")},p:[],r:"undefined"},I={fn:function(e,t,n,r,i){var a,o=n;if(g(i)&&y(o)){a="";for(var u=0;u<o.length;u++)a+=d(o[u])?o[u][r]:"",u<o.length-1&&(a+=i)}else y(o)&&(o=o.length>0?o[0]:{}),a=d(o)?o[r]:null;return void 0===a&&(a=null),e.genValue(a)},p:["undefined","string","string?"],r:"undefined"},A={fn:function(e){return e.genValue(Math.random())},p:[],r:"number"},G={FieldDisplayName:K,FieldName:L,FieldValue:P,IIf:k,IfNull:M,Now:O,Parent:S,PropValue:I,Random:A,RecNo:x,Root:C},D={e:"value",fn:function(e,t){var n=t.toValue().length;return e.genValue(n,"",null,"")},p:[],r:"number"},R={e:"value",fn:function(e,t,n){return n=n||"$0",N.call(e,t,n,function(e,t){return e.add(t)})},p:["expr?"],r:"undefined"},U={e:"value",fn:function(e,t,n){return n=n||"$0",N.call(e,t,n,function(e,t){var n=e.compare(t,">");return""===n.errorMsg&&(n=n.toValue()?e:t),n})},p:["expr?"],r:"undefined"},X={e:"value",fn:function(e,t,n){return n=n||"$0",N.call(e,t,n,function(e,t){var n=e.compare(t,"<");return""===n.errorMsg&&(n=n.toValue()?e:t),n})},p:["expr?"],r:"undefined"},w={e:"value",fn:function(e,t,n){n=n||"$0";var r=N.call(e,t,n,function(e,t){return e.add(t)});if(""===r.errorMsg)if(null===r.toValue())r=e.genValue(0);else{var i=t.toValue().length;r=r.divide(e.genValue(i))}return r},p:["expr?"],r:"number"},j={e:"data",fn:function(e,t,n){n=n||"$0";var r=e.genValue([],"array"),i=[];t.entity&&(r.entity=e.genEntityInfo(t.entity.fullName),r.entity.map=[],r.parentObj=t.parentObj);var a=function(e){for(var t=!1,n=0,r=i;n<r.length;n++){if(t=V(r[n],e))break}return t},o=m.call(e,t,n,function(n,o){var u=n.toValue();a(u)||(i.push(u),r.arrayPush(t.subscript(e.genValue(o))),r.entity&&r.entity.map&&r.entity.map.push(t.entity.map[o]))});return""!==o&&(r=e.genErrorValue(o)),r},p:["expr?"],r:"array"},B={e:"data",fn:function(e,t,n){n=n||"true";var r=e.genValue([],"array");t.entity&&(r.entity=e.genEntityInfo(t.entity.fullName),r.entity.map=[],r.parentObj=t.parentObj);var i=m.call(e,t,n,function(n,i){n.toValue()&&(r.arrayPush(t.subscript(e.genValue(i))),r.entity&&r.entity.map&&r.entity.map.push(t.entity.map[i]))});return""!==i&&(r=e.genErrorValue(i)),r},p:["expr"],r:"array"},F={Average:w,Count:D,Distinct:j,Max:U,Min:X,Sum:R,Where:B},Y={fn:function(e,t){return e.genValue(t.toValue()+"")},p:[],r:"string"},W={ToString:Y},q={fn:function(t,n,r){return t.genValue(e(n.toValue()).format(r||""))},p:["string?"],r:"string"},$={fn:function(t,n){return t.genValue(e(n.toValue()).startOf("day").toDate())},p:[],r:"date"},H={fn:function(t,n){return t.genValue(e(n.toValue()).date())},p:[],r:"number"},J={fn:function(t,n){return t.genValue(e(n.toValue()).day())},p:[],r:"number"},Q={fn:function(t,n,r){return t.genValue(-e(n.toValue()).diff(r,"days"))},p:["date"],r:"number"},z={fn:function(t,n){return t.genValue(e(n.toValue()).hour())},p:[],r:"number"},Z={fn:function(t,n,r){return t.genValue(-e(n.toValue()).diff(r,"hours"))},p:["date"],r:"number"},ee={fn:function(t,n,r){return t.genValue(e(n.toValue()).add(r,"days").toDate())},p:["number"],r:"date"},te={fn:function(t,n,r){return t.genValue(e(n.toValue()).add(r,"hours").toDate())},p:["number"],r:"date"},ne={fn:function(t,n,r){return t.genValue(e(n.toValue()).add(r,"minutes").toDate())},p:["number"],r:"date"},re={fn:function(t,n,r){return t.genValue(e(n.toValue()).add(r,"months").toDate())},p:["number"],r:"date"},ie={fn:function(t,n,r){return t.genValue(e(n.toValue()).add(r,"seconds").toDate())},p:["number"],r:"date"},ae={fn:function(t,n,r){return t.genValue(e(n.toValue()).add(r,"weeks").toDate())},p:["number"],r:"date"},oe={fn:function(t,n,r){return t.genValue(e(n.toValue()).add(r,"years").toDate())},p:["number"],r:"date"},ue={fn:function(t,n){return t.genValue(e(n.toValue()).millisecond())},p:[],r:"number"},se={fn:function(t,n,r){return t.genValue(-e(n.toValue()).diff(r,"milliseconds"))},p:["date"],r:"number"},le={fn:function(t,n){return t.genValue(e(n.toValue()).minute())},p:[],r:"number"},pe={fn:function(t,n,r){return t.genValue(-e(n.toValue()).diff(r,"minutes"))},p:["date"],r:"number"},he={fn:function(t,n){return t.genValue(e(n.toValue()).month()+1)},p:[],r:"number"},ce={fn:function(t,n,r){return t.genValue(-e(n.toValue()).diff(r,"months"))},p:["date"],r:"number"},fe={fn:function(t,n){return t.genValue(e(n.toValue()).second())},p:[],r:"number"},ye={fn:function(t,n,r){return t.genValue(-e(n.toValue()).diff(r,"seconds"))},p:["date"],r:"number"},ge={fn:function(t,n){return t.genValue(e(n.toValue()).week())},p:[],r:"number"},de={fn:function(t,n,r){return t.genValue(-e(n.toValue()).diff(r,"weeks"))},p:["date"],r:"number"},_e={fn:function(t,n){return t.genValue(e(n.toValue()).year())},p:[],r:"number"},Te={fn:function(t,n,r){return t.genValue(-e(n.toValue()).diff(r,"years"))},p:["date"],r:"number"},be={DateOf:$,DayOf:H,DayOfWeek:J,DaysBetween:Q,HourOf:z,HoursBetween:Z,IncDay:ee,IncHour:te,IncMinute:ne,IncMonth:re,IncSecond:ie,IncWeek:ae,IncYear:oe,MilliSecondOf:ue,MilliSecondsBetween:se,MinuteOf:le,MinutesBetween:pe,MonthOf:he,MonthsBetween:ce,SecondOf:fe,SecondsBetween:ye,ToString:q,WeekOf:ge,WeeksBetween:de,YearOf:_e,YearsBetween:Te},ve={fn:function(e,t){return e.genValue(t.toValue()+"")},p:[],r:"string"},Ve={fn:function(e,t){return t.abs()},p:[],r:"number"},Ee={fn:function(e,t){return t.ceil()},p:[],r:"number"},me={fn:function(e,t){return t.floor()},p:[],r:"number"},Ne={fn:function(e,t){return t.cos()},p:[],r:"number"},ke={fn:function(e,t){return t.exp()},p:[],r:"number"},Me={fn:function(e,t){return t.ln()},p:[],r:"number"},Se={fn:function(e,t,n){return t.log(n)},p:["number"],r:"number"},xe={fn:function(e,t,n){return t.power(n)},p:["number"],r:"number"},Ce={fn:function(e,t,n){return t.round(n)},p:["number"],r:"number"},Oe={fn:function(e,t){return t.sin()},p:[],r:"number"},Le={fn:function(e,t){return t.sqrt()},p:[],r:"number"},Ke={fn:function(e,t){return t.tan()},p:[],r:"number"},Pe={fn:function(e,t,n){return t.trunc(n)},p:["number"],r:"number"},Ie={fn:function(e,t,n,r){var i=t.toValue();return e.genValue(_(i)?function(e,t,n){var r=(n?"零壹贰叁肆伍陆柒捌玖":"零一二三四五六七八九").split(""),i=(n?"拾佰仟":"十百千").split("");i.unshift("");var a="万亿兆".split("");a.unshift("");var o=t?"元":"点",u="角分厘".split(""),s=t?"整":"",l="",p=(e+".").split(".",2),h=p[0].split(""),c=p[1].split(""),f="-"===h[0];f&&h.shift(),h=h.reverse();for(var y="",g=0,d=[],_=!0;g<h.length;)if(d.push(h[g++]),4===d.length||g===h.length){for(var T=0;T<d.length;T++){var b=Number(d[T]);0===b?(_||0===T||(y=r[0]+y),_=!0):(y=r[b]+i[T]+y,_=!1)}0===y.length?l.length>0&&l.split("")[0]!==r[0]&&(l=r[0]+l):l=y+(a[Math.floor((g-1)/4)]||"")+l,y="",d=[]}if(c.length>0){l+=o;for(var v=0;v<c.length;v++){var V=Number(c[v]);t?((0!==V||l.substring(l.length-1)!==r[0]||v>2)&&(l+=r[V]),(0!==V||l.substring(l.length-1)===r[0]&&2===v)&&(l+=u[v]||"")):l+=r[V]}}else 0===l.length&&(l=r[0]),t&&(l+=o+s);return t||l.substring(0,2)!==r[1]+i[1]||(l=l.substring(1)),l.split("")[0]===o&&(l=t?l.substring(1):r[0]+l),f&&(l="负"+l),l}(i,void 0===n||n,void 0===r||r):null)},p:["boolean?","boolean?"],r:"string"},Ae={Abs:Ve,Ceil:Ee,Cos:Ne,Exp:ke,Floor:me,Ln:Me,Log:Se,Power:xe,Round:Ce,Sin:Oe,Sqrt:Le,Tan:Ke,ToRMB:Ie,ToString:ve,Trunc:Pe},Ge={e:"parent",fn:function(e,t){return e.getParentValue(t)},p:[],r:"object"},De={e:"value",fn:function(e,t){return e.getRecNo(t)},p:[],r:"number"},Re={Parent:Ge,RecNo:De},Ue=function(){function e(){this.localeName="zh-cn",this.locales={},this.functions={}}return e.prototype.defineLocale=function(e,t){null!==t?this.locales[e]=E(this.locales[e]||{},t):delete this.locales[e]},e.prototype.getLocale=function(e){return this.locales[e||this.localeName]},e.prototype.defineFunction=function(e,t){null!==t?this.functions[e]=E(this.functions[e]||{},t):delete this.functions[e]},e.prototype.getFunction=function(e){return this.functions[e||this.localeName]},e}(),Xe=new Ue,we={fn:function(e,t){return e.genValue(t.toValue()+"")},p:[],r:"string"},je={fn:function(e,t){var n=Number(t.toValue());return isNaN(n)?e.genErrorValue(t.toValue()+"无法被转换为数字"):e.genValue(n)},p:[],r:"number"},Be={fn:function(t,n,r){r=r||"";var i=n.toValue(),a=e(i,r);return a.isValid()?t.genValue(a.toDate()):t.genErrorValue(i+" 无法被 "+r+" 格式化为日期时间")},p:["string?"],r:"date"},Fe={fn:function(e,t){var n=t.toValue();return e.genValue(g(n)?n.length:null)},p:[],r:"number"},Ye={fn:function(e,t){var n=t.toValue();return e.genValue(g(n)?n.toUpperCase():null)},p:[],r:"string"},We={fn:function(e,t){var n=t.toValue();return e.genValue(g(n)?n.toLowerCase():null)},p:[],r:"string"},qe={fn:function(e,t){var n=t.toValue();return e.genValue(g(n)?n.trim():null)},p:[],r:"string"},$e={fn:function(e,t){var n=t.toValue();return e.genValue(g(n)?n.replace(/^\s+/g,""):null)},p:[],r:"string"},He={fn:function(e,t){var n=t.toValue();return e.genValue(g(n)?n.replace(/\s+$/g,""):null)},p:[],r:"string"},Je={fn:function(e,t,n,r){var i=t.toValue(),a=n>=0?n:i.toString().length+n,o=a+r;return a>o&&(o=a),e.genValue(g(i)&&_(n)&&_(r)?i.substring(a,o):null)},p:["number","number"],r:"string"},Qe={fn:function(e,t,n){var r=t.toValue();return e.genValue(g(r)&&_(n)?r.substring(0,n):null)},p:["number"],r:"string"},ze={fn:function(e,t,n){var r=t.toValue();return e.genValue(g(r)&&_(n)?r.substring(r.length-n,r.length):null)},p:["number"],r:"string"},Ze={fn:function(e,t,n){var r=t.toValue();return e.genValue(g(r)&&g(n)?r.indexOf(n):null)},p:["string"],r:"number"},et={fn:function(e,t,n,r,i){var a,o;void 0===i&&(i="g");var u=t.toValue(),s=0,l=n.length;if(/^m?g?i?$/.test(i))if(/g/.test(i))if(/i/.test(i))for(s=u.toUpperCase().indexOf(n.toUpperCase(),s);-1!==s;){o=u.split("");var p=[s,l];p=p.concat(r.split("")),Array.prototype.splice.apply(o,p),u=o.join(""),s=u.toUpperCase().indexOf(n.toUpperCase(),s)}else for(s=u.indexOf(n,s);-1!==s;){o=u.split("");var p=[s,l];p=p.concat(r.split("")),Array.prototype.splice.apply(o,p),u=o.join(""),s=u.indexOf(n,s)}else if(/i/.test(i)){if(-1!==(s=u.toUpperCase().indexOf(n.toUpperCase(),s))){o=u.split("");var p=[s,l];p=p.concat(r.split("")),Array.prototype.splice.apply(o,p),u=o.join("")}}else u=u.replace(n,r);else a=e.genErrorValue(f(Xe.getLocale().MSG_EF_MODEL,i));return a||(a=e.genValue(u)),a},p:["string","string","string?"],r:"string"},tt={fn:function(e,t,n,r,i){var a;void 0===i&&(i="g");var o,u=t.toValue();try{o=new RegExp(n,i)}catch(t){a=e.genErrorValue(f(Xe.getLocale().MSG_EF_MODEL,i))}return u=u.replace(o,r),a||(a=e.genValue(u)),a},p:["string","string","string?"],r:"string"},nt={LeftString:Qe,Length:Fe,Lower:We,Pos:Ze,Replace:et,ReplaceReg:tt,RightString:ze,SubString:Je,ToDate:Be,ToNumber:je,ToString:we,Trim:qe,TrimLeft:$e,TrimRight:He,Upper:Ye},rt={_:G,array:F,boolean:W,date:be,number:Ae,object:Re,string:nt},it=function(){function e(){this.expr=[],this.index=0}return e.prototype.setExpr=function(e){return this.expr=e?e.split(""):[],this.reset(),this},e.prototype.reset=function(){return this.index=0,this},e.prototype.nextToken=function(){for(var e,t=this.index,n=this.expr,r=!1;t<n.length&&" "===n[t];)t++;var p="",h="",c="",y=t+1;if(!(t<n.length))return null;switch(n[t]){case"[":case"]":case"{":case"}":case".":case"(":case")":case"*":case"/":case"%":case"+":case"-":case":":case",":c=p=n[t++],h="["===p?"TK_LA":"]"===p?"TK_RA":"{"===p?"TK_LO":"}"===p?"TK_RO":"."===p?"TK_DOT":"("===p?"TK_LP":")"===p?"TK_RP":"*"===p?"TK_MULTI":"/"===p?"TK_DIV":"%"===p?"TK_MOD":"+"===p?"TK_PLUS":"-"===p?"TK_MINUS":":"===p?"TK_COLON":","===p?"TK_COMMA":"";break;case"!":p=n[t++],t<n.length&&"="===n[t]?(p+=n[t++],h="TK_CO"):h="TK_NOT",c=p;break;case">":case"<":p=n[t++],t<n.length&&"="===n[t]&&(p+=n[t++]),c=p,h="TK_CO";break;case"=":case"&":case"|":p=n[t++],t<n.length&&n[t]===p?(h="&"===p?"TK_AND":"|"===p?"TK_OR":"TK_CO",p+=n[t++]):h="TK_UNKNOWN",c=p;break;case"'":case'"':var g=n[t],d=[],_=!1;for(p+=n[t++];!r&&t<n.length;){if("\\"===n[t])switch(n[t+1]){case"\\":t++,d.push("\\");break;case"n":t++,d.push("\n");break;case"'":t++,d.push("'");break;case'"':t++,d.push('"');break;case"t":t++,d.push("\t");break;case"b":t++,d.push("\b");break;case"r":t++,d.push("\r");break;case"f":t++,d.push("\f");break;case"u":var T=n.join("").substring(t+2,t+6);o(n[t+2])&&o(n[t+3])&&o(n[t+4])&&o(n[t+5])?(d.push(String.fromCharCode(parseInt(T,16))),t+=5):(r=!0,e={tokenErrorMsg:f(Xe.getLocale().MSG_EL_SYNTAX_UC,"\\u"+T),tokenIndex:t,tokenType:"TK_STRING"});break;case"x":var b=n.join("").substring(t+2,t+4);o(n[t+2])&&o(n[t+3])?(d.push(String.fromCharCode(parseInt(b,16))),t+=3):(r=!0,e={tokenErrorMsg:f(Xe.getLocale().MSG_EL_SYNTAX_XN,"\\x"+b),tokenIndex:t,tokenType:"TK_STRING"});break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":var v=n.join("").substring(t+1,t+4);a(n[t+1])&&a(n[t+2])&&a(n[t+3])?(d.push(String.fromCharCode(parseInt(v,8))),t+=3):(r=!0,e={tokenErrorMsg:f(Xe.getLocale().MSG_EL_SYNTAX_ON,"\\"+v),tokenIndex:t,tokenType:"TK_STRING"});break;default:t++,d.push(n[t])}else{if(n[t]===g){_=!0;break}d.push(n[t])}t++}if(!r){if(!0!==_){r=!0,e={tokenErrorMsg:f(Xe.getLocale().MSG_EL_SYNTAX_S,p+d.join("")),tokenIndex:t,tokenType:"TK_STRING"};break}p+=d.join("")+g,t++,c=p,p=d.join(""),h="TK_STRING"}break;default:if(p=n[t++],i(p)){for(;t<n.length&&i(n[t])&&("."!==n[t]||i(n[t+1]));)p+=n[t++];h=s(p)?"TK_NUMBER":"TK_UNKNOWN"}else if(u(p)){for(;t<n.length&&u(n[t]);)p+=n[t++];switch(p){case"true":case"false":h="TK_BOOL";break;case"null":h="TK_NULL";break;default:h="TK_IDEN"}}else{for(;t<n.length&&l(n[t]);)p+=n[t++];h="TK_UNKNOWN"}c=p}if("TK_PLUS"===h||"TK_MINUS"===h){for(var V=t-c.length-1;V>=0;){if("({[+-*/%><=&|:,".indexOf(n[V])>=0){h="TK_UNARY";break}if(" "!==n[V])break;V--}-1===V&&(h="TK_UNARY")}return this.index=t,r||(e={tokenIndex:y,tokenText:c,tokenType:h,tokenValue:p}),e},e}(),at="TK_UNKNOWN,TK_STRING,TK_NUMBER,TK_BOOL,TK_NULL,TK_IDEN,TK_DOT,TK_LP,TK_LA,TK_LO,TK_RP,TK_RA,TK_RO,TK_UNARY,TK_NOT,TK_MULTI,TK_DIV,TK_MOD,TK_PLUS,TK_MINUS,TK_CO,TK_AND,TK_OR,TK_COLON,TK_COMMA".split(","),ot=function(e,t){var n={};return e.forEach(function(e,r){return n[e]="1"===t[r]}),n},ut=ot(at,"0111110111000110000000000".split("")),st=ot(at,"0111110000111000000000000".split("")),lt=function(e,t){var n={};return e.forEach(function(r,i){return n[r]=ot(e,t[i].split(""))}),n}(at,"0000000000000000000000000,0000001010111001111111111,0000001000111001111111111,0000001000111001111111111,0000000000111001111111111,0000001110111001111111111,0000010000000000000000000,0111110111100110000000000,0111110111010110000000000,0111110000001000000000000,0000001010111001111111101,0000001010111001111111101,0000001011111001111111101,0111110111000110000000000,0111110111000110000000000,0111110111000110000000000,0111110111000110000000000,0111110111000110000000000,0111110111000110000000000,0111110111000110000000000,0111110111000110000000000,0111110111000110000000000,0111110111000110000000000,0111110111000110000000000,0111110111000110000000000".split(",")),pt=function(){function e(){this.tokens=[],this.rootToken=null,this.errorMsg="",this.lexer=new it}return e.prototype.parser=function(e){return this.doInit(e),""===this.errorMsg&&(this.errorMsg=this.doDoublyLinkedList()),""===this.errorMsg&&(this.rootToken=this.doParser(this.tokens)),""===this.errorMsg&&this.rootToken&&(this.errorMsg=this.doCheckSyntax(this.rootToken)),this},e.prototype.doInit=function(e){e?(this.rootToken=null,this.tokens=[],this.errorMsg="",this.lexer.setExpr(e)):this.errorMsg=Xe.getLocale().MSG_EP_EMPTY},e.prototype.doCreateVirtualToken=function(e){var t;switch(e){case"VTK_COMMA":t=",";break;case"VTK_PAREN":t="()";break;case"VTK_ARRAY":t="[]";break;case"VTK_OBJECT":t="{}";break;case"VTK_SUBSCRIPT":t="[n]";break;case"VTK_FUNCTION":t="Fn()";break;default:t=""}return{childs:[],parent:null,tokenText:t,tokenType:e,tokenValue:t}},e.prototype.doDoublyLinkedList=function(){for(var e=this.lexer.nextToken(),t=this.tokens,n=[],r="";!r&&e;){if("TK_UNKNOWN"===e.tokenType){r=f(Xe.getLocale().MSG_EP_UNKNOWN,e.tokenText);break}if("TK_STRING"===e.tokenType&&e.tokenErrorMsg){r=e.tokenErrorMsg;break}if(e.parent=null,e.childs=[],this.tokens.push(e),1===t.length&&!ut[e.tokenType]){r=f(Xe.getLocale().MSG_EP_LEXICAL_B,e.tokenText);break}if(1!==t.length&&!lt[t[t.length-2].tokenType][e.tokenType]){r=f(Xe.getLocale().MSG_EP_LEXICAL_L,t[t.length-2].tokenText,e.tokenText);break}switch(e.tokenType){case"TK_LP":case"TK_LA":case"TK_LO":n.push(e);break;case"TK_RP":case"TK_RA":case"TK_RO":n.length?e.tokenType.replace("R","L")===n[n.length-1].tokenType?n.pop():r=f(Xe.getLocale().MSG_EP_MATCH,n[n.length-1].tokenText):r=f(Xe.getLocale().MSG_EP_MATCH,e.tokenText)}e=this.lexer.nextToken()}return r||st[t[t.length-1].tokenType]||(r=f(Xe.getLocale().MSG_EP_LEXICAL_E,t[t.length-1].tokenText)),!r&&n.length&&(r=f(Xe.getLocale().MSG_EP_MATCH,n[n.length-1].tokenText)),r},e.prototype.doParser=function(e){var t=null;return e&&!e.length?t:(t=this.doParser_0(e),t=this.doParser_1(t),t=this.doParser_2(t),t=this.doParser_3(t),t=this.doParser_4(t,"TK_MULTI,TK_DIV,TK_MOD"),t=this.doParser_4(t,"TK_PLUS,TK_MINUS"),t=this.doParser_4(t,"TK_CO,TK_EO"),t=this.doParser_4(t,"TK_AND"),t=this.doParser_4(t,"TK_OR"),t=this.doParser_4(t,"TK_COLON"),t=this.doParser_5(t),t.length>1&&(this.errorMsg="语法解析错误"),t[0])},e.prototype.doCheckSyntax=function(e){var t,n="",i=0;return c(this.rootToken,function(e){switch(e.id=i++,t=e.tokenText,e.tokenType){case"TK_DOT":"TK_IDEN"!==e.childs[1].tokenType||r("VTK_FUNCTION,TK_IDEN,TK_DOT,VTK_SUBSCRIPT,VTK_PAREN,VTK_OBJECT",e.childs[0].tokenType)||(n=f(Xe.getLocale().MSG_EP_SYNTAX_D,e.childs[0].tokenType));break;case"TK_COLON":e.parent&&r("VTK_OBJECT,VTK_COMMA",e.parent.tokenType)?e.childs&&e.childs[0]&&e.childs[0].childs&&e.childs[0].childs.length>0&&(n=f(Xe.getLocale().MSG_EP_SYNTAX_E,t)):n=f(Xe.getLocale().MSG_EP_SYNTAX_P,t);break;case"VTK_COMMA":e.parent&&r("VTK_OBJECT,VTK_ARRAY,VTK_PAREN",e.parent.tokenType)||(n=f(Xe.getLocale().MSG_EP_SYNTAX_C,t));break;case"VTK_PAREN":(e.parent&&"TK_IDEN"!==e.parent.tokenType||!e.parent)&&(0===e.childs.length?n=f(Xe.getLocale().MSG_EP_SYNTAX_N,t):"VTK_COMMA"===e.childs[0].tokenType&&(n=f(Xe.getLocale().MSG_EP_SYNTAX_M,t)));break;case"VTK_ARRAY":if(e.childs&&e.childs.length>0)if("TK_COLON"===e.childs[0])n=f(Xe.getLocale().MSG_EP_SYNTAX_A,":");else if("VTK_COMMA"===e.childs[0].tokenType&&(e.parent&&"VTK_SUBSCRIPT"===e.parent.tokenType&&e.parent.childs[0]!==e&&(n=f(Xe.getLocale().MSG_EP_SYNTAX_SUB,",")),e.childs[0].childs))for(var a=0,o=e.childs[0].childs;a<o.length;a++){var u=o[a];if("TK_COLON"===u.tokenType){n=f(Xe.getLocale().MSG_EP_SYNTAX_A,":");break}}break;case"VTK_OBJECT":var s=!1;if(e.childs&&(0===e.childs.length||r("TK_COLON,VTK_COMMA",e.childs[0].tokenType)))if(e.childs.length>0&&"VTK_COMMA"===e.childs[0].tokenType){if(e.childs[0].childs)for(var l=0,p=e.childs[0].childs;l<p.length;l++){var u=p[l];if(!(s="TK_COLON"===u.tokenType))break}}else s=!0;s||(n=Xe.getLocale().MSG_EP_SYNTAX_O)}if(""!==n)return!1},this),n},e.prototype.doParser_0=function(e){for(var t,n=[],i=0,a=[],o=0;o<e.length;){if(t=e[o],r("TK_LP,TK_LA,TK_LO",t.tokenType)?i++:r("TK_RP,TK_RA,TK_RO",t.tokenType)&&i--,i>0)a.push(t);else if(a.length>0){var u=a.shift(),s=void 0;switch(u.tokenType){case"TK_LP":s="VTK_PAREN";break;case"TK_LA":s="VTK_ARRAY";break;case"TK_LO":s="VTK_OBJECT"}t=this.doCreateVirtualToken(s),t.tokenIndex=u.tokenIndex;var l=this.doParser(a);l&&(t.childs.push(l),l.parent=t),n.push(t),a=[]}else n.push(t);o++}return n},e.prototype.doParser_1=function(e){for(var t,n,r=[],i=0;i<e.length;){if(t=e[i],n=e[i+1],"TK_IDEN"===t.tokenType&&n&&"VTK_PAREN"===n.tokenType){var a=this.doCreateVirtualToken("VTK_FUNCTION");a.tokenIndex=t.tokenIndex,a.childs.push(t),t.parent=a,a.childs.push(n),n.parent=t,i++,r.push(a)}else r.push(t);i++}return r},e.prototype.doParser_2=function(e){for(var t,n,i=[],a=0;a<e.length;){if(t=e[a],(n=e[a+1])&&("TK_DOT"===n.tokenType||"VTK_ARRAY"===n.tokenType&&r("TK_IDEN,TK_STRING,VTK_PAREN,VTK_FUNCTION,VTK_ARRAY,VTK_OBJECT",t.tokenType))){do{switch(n.tokenType){case"TK_DOT":n.childs.push(t),t.parent=n,a+=2,t=e[a],n.childs.push(t),t.parent=n,t=n,n=e[a+1];break;case"VTK_ARRAY":var o=this.doCreateVirtualToken("VTK_SUBSCRIPT");o.childs.push(t),t.parent=o,o.childs.push(n),n.parent=o,t=o,a++,n=e[a+1]}}while(n&&("TK_DOT"===n.tokenType||"VTK_ARRAY"===n.tokenType));i.push(t)}else i.push(t);a++}return i},e.prototype.doParser_3=function(e){for(var t,n=[],i=0;i<e.length;){if(t=e[i],r("TK_UNARY,TK_NOT",t.tokenType)){n.push(t);do{var a=e[++i];t.childs.push(a),a.parent=t,t=e[i]}while(r("TK_UNARY,TK_NOT",t.tokenType))}else n.push(t);i++}return n},e.prototype.doParser_4=function(e,t){for(var n,i,a=[],o=0;o<e.length;){if(n=e[o],(i=e[o+1])&&r(t,i.tokenType)){for(var u=void 0;;){if(i.childs.push(n),n.parent=i,u=i,o+=2,n=e[o],i=e[o+1],u.childs.push(n),n.parent=u,!i||!r(t,i.tokenType))break;n=u}a.push(u)}else a.push(n);o++}return a},e.prototype.doParser_5=function(e){for(var t,n,r=[],i=0;i<e.length;){if(t=e[i],(n=e[i+1])&&"TK_COMMA"===n.tokenType){var a=this.doCreateVirtualToken("VTK_COMMA");for(a.tokenIndex=n.tokenIndex;n&&"TK_COMMA"===n.tokenType;)a.childs.push(t),t.parent=a,i+=2,t=e[i],n=e[i+1];a.childs.push(t),t.parent=a,r.push(a)}else r.push(t);i++}return r},e}(),ht=function(){function e(e,t,n,r,i,a,o){this.context=e,this.type=t||"undefined",this.info=n||t,this.data=r,this.entity=i||null,this.depends=a||null,this.errorMsg=o||""}return e.prototype.genType=function(t,n,r,i,a,o){return new e(this.context,t,n,r,i,a,o)},e.prototype.genErrorType=function(e){return this.genType(void 0,void 0,void 0,void 0,void 0,e)},e.prototype.hasData=function(){return void 0!==this.data},e.prototype.toValue=function(){return this.type},e.prototype.arrayPush=function(e){return"array"===this.type&&(this.info.push(e.info),this.data.push(e.data)),this},e.prototype.arrayConcat=function(e){return"array"===this.type&&"array"===e.type&&(this.info=this.info.concat(e.info),this.data=this.data.concat(e.data)),this},e.prototype.objectSetProperty=function(e){if("object"===this.type){var t=e.info;this.info[t.key]=t.value;var n=e.data;this.data[n.key]=n.value}return this},e.prototype.objectSetProperties=function(e){if("object"===this.type&&"array"===e.type){for(var t=0,n=e.info;t<n.length;t++){var r=n[t];this.info[r.key]=r.value}for(var i=0,a=e.data;i<a.length;i++){var r=a[i];this.data[r.key]=r.value}}return this},e.prototype.negative=function(e){var t;return"null"===this.type||"undefined"===this.type||"number"===this.type?t=this.genType("number"):(t="-"===e?Xe.getLocale().MSG_EX_NEGATIVE:Xe.getLocale().MSG_EX_POSITIVE,t=this.genErrorType(f(t,this.type))),t},e.prototype.not=function(){return this.genType("boolean")},e.prototype.multiply=function(e){return"null"===this.type&&"null"===e.type?this.genType("null"):"number"!==this.type&&"null"!==this.type&&"undefined"!==this.type||"number"!==e.type&&"null"!==e.type&&"undefined"!==e.type?this.genErrorType(f(Xe.getLocale().MSG_EX_MULTIPLY,this.type,e.type)):this.genType("number")},e.prototype.divide=function(e){return"null"===this.type&&"null"===e.type?this.genType("null"):"number"!==this.type&&"null"!==this.type&&"undefined"!==this.type||"number"!==e.type&&"undefined"!==e.type?this.genErrorType(f(Xe.getLocale().MSG_EX_DIVIDE,this.type,e.type)):e.hasData()&&("null"===e.data||"number"===e.type&&0===Number(e.data))?this.genErrorType(f(Xe.getLocale().MSG_EX_DIVIDE_N,e.info)):this.genType("number")},e.prototype.remainder=function(e){return"null"===this.type&&"null"===e.type?this.genType("null"):"number"!==this.type&&"null"!==this.type&&"undefined"!==this.type||"number"!==e.type&&"undefined"!==e.type?this.genErrorType(f(Xe.getLocale().MSG_EX_REMAINDER,this.type,e.type)):e.hasData()&&("null"===e.data||"number"===e.type&&0===Number(e.data))?this.genErrorType(f(Xe.getLocale().MSG_EX_REMAINDER_N,e.info)):this.genType("number")},e.prototype.add=function(e){return"undefined"===this.type&&"undefined"===e.type?this.genType("undefined"):"null"===this.type&&"null"===e.type?this.genType("null"):"number"!==this.type&&"null"!==this.type&&"undefined"!==this.type||"number"!==e.type&&"null"!==e.type&&"undefined"!==e.type?"string"!==this.type&&"number"!==this.type&&"null"!==this.type&&"undefined"!==this.type||"string"!==e.type&&"number"!==e.type&&"null"!==e.type&&"undefined"!==e.type?"array"!==this.type&&"null"!==this.type&&"undefined"!==this.type||"array"!==e.type&&"null"!==e.type&&"undefined"!==e.type?this.genErrorType(f(Xe.getLocale().MSG_EX_ADD,this.type,e.type)):this.genType("array"):this.genType("string"):this.genType("number")},e.prototype.subtract=function(e){return"undefined"===this.type&&"undefined"===e.type?this.genType("undefined"):"null"===this.type&&"null"===e.type?this.genType("null"):"number"!==this.type&&"null"!==this.type&&"undefined"!==this.type||"number"!==e.type&&"null"!==e.type&&"undefined"!==e.type?"array"!==this.type&&"null"!==this.type&&"undefined"!==this.type||"array"!==e.type&&"null"!==e.type&&"undefined"!==e.type?this.genErrorType(f(Xe.getLocale().MSG_EX_SUBTRACT,this.type,e.type)):this.genType("array"):this.genType("number")},e.prototype.equal=function(e,t){var n,r="=="===t;return"undefined"===this.type||"undefined"===e.type||"null"===this.type||"null"===e.type||this.type===e.type?n=this.genType("boolean"):(n=r?Xe.getLocale().MSG_EX_EQUAL:Xe.getLocale().MSG_EX_EQUAL_N,n=this.genErrorType(f(n,this.type,e.type))),n},e.prototype.compare=function(e,t){if("=="===t||"!="===t)return this.equal(e,t);var n=void 0;if("undefined"===this.type||"undefined"===e.type||"null"===this.type||"null"===e.type||this.type===e.type&&("string"===e.type||"date"===e.type||"number"===e.type))n=this.genType("boolean");else{switch(t){case">":n=Xe.getLocale().MSG_EX_COMPARE_A;break;case"<":n=Xe.getLocale().MSG_EX_COMPARE_B;break;case">=":n=Xe.getLocale().MSG_EX_COMPARE_C;break;case"<=":n=Xe.getLocale().MSG_EX_COMPARE_D}n=this.genErrorType(f(n,this.type,e.type))}return n},e.prototype.and=function(e){return"undefined"===this.type||"undefined"===e.type||"null"===this.type||"null"===e.type||"boolean"===this.type&&"boolean"===e.type?this.genType("boolean"):this.genErrorType(f(Xe.getLocale().MSG_EX_AND,this.type,e.type))},e.prototype.or=function(e){return"undefined"===this.type||"undefined"===e.type||"null"===this.type||"null"===e.type||"boolean"===this.type&&"boolean"===e.type?this.genType("boolean"):this.genErrorType(f(Xe.getLocale().MSG_EX_OR,this.type,e.type))},e.prototype.subscript=function(e){var t,n;return n="array"===e.type?e.info[0]:e.info,"string"===this.type||"array"===this.type?t="number"===n?"array"===this.type&&this.entity?this.context.getEntityType(this):"string"===this.type?this.genType("string"):this.genType("undefined"):this.genErrorType(f(Xe.getLocale().MSG_EX_SUBSCRIPT_T,n)):"object"===this.type?(t=this.genType("string","string",n),t=t.getVariableType(this)):t="undefined"===this.type?this.genType("undefined"):this.genErrorType(f(Xe.getLocale().MSG_EX_SUBSCRIPT,this.type)),t},e.prototype.hashItem=function(e){return this.genType("object",{key:this.data,value:e.info},{key:this.data,value:e.data})},e.prototype.getVariableType=function(e){return this.context.getVariableType(this.data,e)},e.prototype.getFunctionType=function(e){return this.context.getFunctionType(this.info.key,e,this.info.value,this.data.value)},e}(),ct=function(e){return new t(e)},ft=function(){function e(e,t,n,r,i,a){this.context=e,this.type=n||T(t),"number"===this.type&&(t+=""),this.value=t,this.entity=r||null,this.errorMsg=i||"",this.parentObj=a||null}return e.prototype.genValue=function(t,n,r,i,a){return new e(this.context,t,n,r,i,a)},e.prototype.genErrorValue=function(e){return this.genValue(void 0,void 0,void 0,e,void 0)},e.prototype.toValue=function(){return"number"===this.type?Number(this.value):this.value},e.prototype.isEntity=function(){return null!=this.entity},e.prototype.arrayPush=function(e){return"array"===this.type&&(e=e||this.genValue(null),this.toValue().push(e.toValue())),this},e.prototype.arrayConcat=function(e){
return"array"===this.type&&"array"===e.type&&(this.value=this.toValue().concat(e.toValue())),this},e.prototype.objectSetProperty=function(e){if("object"===this.type){var t=e.toValue();this.value[t.key]=t.value}return this},e.prototype.objectSetProperties=function(e){if("object"===this.type&&"array"===e.type)for(var t=e.toValue(),n=0,r=t;n<r.length;n++){var i=r[n];this.value[i.key]=i.value}return this},e.prototype.negative=function(e){var t;return"null"===this.type?t=this.genValue("0","number"):"number"===this.type?(t="-"===e?ct(this.value).times(ct(-1)).toString():this.value,t=this.genValue(t,"number")):(t="-"===e?Xe.getLocale().MSG_EX_NEGATIVE:Xe.getLocale().MSG_EX_POSITIVE,t=this.genErrorValue(f(t,this.type))),t},e.prototype.not=function(){return"boolean"===this.type?this.genValue(!this.value,"boolean"):"string"===this.type&&""===this.value||"number"===this.type&&"0"===this.value||"null"===this.type?this.genValue(!0,"boolean"):this.genValue(!1,"boolean")},e.prototype.multiply=function(e){var t;if("null"===this.type&&"null"===e.type)t=this.genValue(null,"null");else if("number"!==this.type&&"null"!==this.type||"number"!==e.type&&"null"!==e.type)t=this.genErrorValue(f(Xe.getLocale().MSG_EX_MULTIPLY,this.type,e.type));else{var n=ct(this.value||"0"),r=ct(e.value||"0");t=this.genValue(n.times(r).toString(),"number")}return t},e.prototype.divide=function(e){var t;if("null"===this.type&&"null"===e.type)t=this.genValue(null,"null");else if("null"===e.type||"number"===e.type&&"0"===e.value)t=this.genErrorValue(f(Xe.getLocale().MSG_EX_DIVIDE_N,e.value));else if("number"!==this.type&&"null"!==this.type||"number"!==e.type)t=this.genErrorValue(f(Xe.getLocale().MSG_EX_DIVIDE,this.type,e.type));else{var n=ct(this.value||"0"),r=ct(e.value);t=this.genValue(n.div(r,10,1).toString(),"number")}return t},e.prototype.remainder=function(e){var t;if("null"===this.type&&"null"===e.type)t=this.genValue(null,"null");else if("null"===e.type||"number"===e.type&&"0"===e.value)t=this.genErrorValue(f(Xe.getLocale().MSG_EX_REMAINDER_N,e.value));else if("number"!==this.type&&"null"!==this.type||"number"!==e.type)t=this.genErrorValue(f(Xe.getLocale().MSG_EX_REMAINDER,this.type,e.type));else{var n=ct(this.value||"0"),r=ct(e.value);t=this.genValue(n.mod(r).toString(),"number")}return t},e.prototype.add=function(e){var t,n,r;return"null"===this.type&&"null"===e.type?t=this.genValue(null,"null"):"number"!==this.type&&"null"!==this.type||"number"!==e.type&&"null"!==e.type?"string"!==this.type&&"null"!==this.type||"string"!==e.type&&"null"!==e.type?"array"!==this.type&&"null"!==this.type||"array"!==e.type&&"null"!==e.type?t=this.genErrorValue(f(Xe.getLocale().MSG_EX_ADD,this.type,e.type)):(n=this.value||[],r=e.value||[],t=this.genValue(n.concat(r),"array")):(n=this.toValue(),r=e.toValue(),n=n||"",r=r||"",t=this.genValue(n+r,"string")):(n=ct(this.value||"0"),r=ct(e.value||"0"),t=this.genValue(n.plus(r).toString(),"number")),t},e.prototype.subtract=function(e){var t,n,r;if("null"===this.type&&"null"===e.type)t=this.genValue(null,"null");else if("number"!==this.type&&"null"!==this.type||"number"!==e.type&&"null"!==e.type)if("array"!==this.type&&"null"!==this.type||"array"!==e.type&&"null"!==e.type)t=this.genErrorValue(f(Xe.getLocale().MSG_EX_SUBTRACT,this.type,e.type));else{n=this.value||[],r=e.value||[],t=[];for(var i=void 0,a=0,o=n;a<o.length;a++){var u=o[a];i=!1;for(var s=0,l=r;s<l.length;s++){var p=l[s];if(i=V(u,p))break}i||t.push(u)}t=this.genValue(t,"array")}else n=ct(this.value||"0"),r=ct(e.value||"0"),t=this.genValue(n.minus(r).toString(),"number");return t},e.prototype.equal=function(e,t){var n,r,i,a="=="===t;return"null"===this.type&&"null"===e.type?n=this.genValue(a,"boolean"):"null"===this.type||"null"===e.type?n=this.genValue(!a,"boolean"):"number"===this.type&&"number"===e.type?(r=ct(this.value),i=ct(e.value),n=r.equals(i),n=this.genValue(a?n:!n,"boolean")):this.type===e.type?(n=V(this.value,e.value),n=this.genValue(a?n:!n,"boolean")):(n=a?Xe.getLocale().MSG_EX_EQUAL:Xe.getLocale().MSG_EX_EQUAL_N,n=this.genErrorValue(f(n,this.type,e.type))),n},e.prototype.compare=function(e,t){if("=="===t||"!="===t)return this.equal(e,t);var n=void 0;if("string"!==this.type&&"null"!==this.type||"string"!==e.type&&"null"!==e.type)if("date"!==this.type&&"null"!==this.type||"date"!==e.type&&"null"!==e.type)if("number"!==this.type&&"null"!==this.type||"number"!==e.type&&"null"!==e.type){switch(t){case">":n=Xe.getLocale().MSG_EX_COMPARE_A;break;case"<":n=Xe.getLocale().MSG_EX_COMPARE_B;break;case">=":n=Xe.getLocale().MSG_EX_COMPARE_C;break;case"<=":n=Xe.getLocale().MSG_EX_COMPARE_D}n=this.genErrorValue(f(n,this.type,e.type))}else{var r=void 0,i=void 0;switch(r=ct(this.value||"0"),i=ct(e.value||"0"),t){case">":n=r.greaterThan(i);break;case"<":n=r.lessThan(i);break;case">=":n=r.greaterThanOrEqualTo(i);break;case"<=":n=r.lessThanOrEqualTo(i)}n=this.genValue(n,"boolean")}else{switch(n=this.value-e.value,t){case">":n=n>0;break;case"<":n=n<0;break;case">=":n=n>=0;break;case"<=":n=n<=0}n=this.genValue(n,"boolean")}else{switch(t){case">":n=this.value>e.value;break;case"<":n=this.value<e.value;break;case">=":n=this.value>=e.value;break;case"<=":n=this.value<=e.value}n=this.genValue(n,"boolean")}return n},e.prototype.and=function(e){return e?"boolean"!==this.type||"boolean"!==e.type&&"null"!==e.type?this.genErrorValue(f(Xe.getLocale().MSG_EX_AND,this.type,e.type)):this.genValue(!(!this.value||!e.value),"boolean"):"boolean"===this.type||"null"===this.type?this.genValue(!1,"boolean"):this.genErrorValue(f(Xe.getLocale().MSG_EX_AND_L,this.type))},e.prototype.or=function(e){return e?"boolean"!==this.type&&"null"!==this.type||"boolean"!==e.type&&"null"!==e.type?this.genErrorValue(f(Xe.getLocale().MSG_EX_OR,this.type,e.type)):this.genValue(!(!this.value&&!e.value),"boolean"):"boolean"===this.type?this.genValue(!0,"boolean"):this.genErrorValue(f(Xe.getLocale().MSG_EX_OR_L,this.type))},e.prototype.subscript=function(e){var t,n,r;return"array"===e.type?(n=e.toValue()[0],r=T(n)):(n=e.toValue(),r=e.type),"string"===this.type||"array"===this.type?"number"===r?(t=this.toValue(),t.length>n&&n>=0&&t.length>0?"array"===this.type&&this.entity?t=this.context.getEntityValue(this,n):(t=t[n],t=this.genValue(t,T(t),null)):t=this.genErrorValue(f(Xe.getLocale().MSG_EX_SUBSCRIPT_U,this.type,n))):t=this.genErrorValue(f(Xe.getLocale().MSG_EX_SUBSCRIPT_T,n)):"object"===this.type?(t=this.genValue(n),t=t.getVariableValue(this)):t=this.genErrorValue(f(Xe.getLocale().MSG_EX_SUBSCRIPT,this.type)),t},e.prototype.hashItem=function(e){return this.genValue({key:this.toValue(),value:e.toValue()},"object")},e.prototype.getVariableValue=function(e){return e&&"object"!==e.type?this.genErrorValue(f(Xe.getLocale().MSG_EX_DOT,e.type)):this.context.getVariableValue(this.toValue(),e)},e.prototype.getFunctionValue=function(e){var t=this.toValue();return t=e&&null===e.value?this.genErrorValue(f(Xe.getLocale().MSG_EX_FUNC_NULL,t.key)):this.context.getFunctionValue(t.key,e,t.value)},e.prototype.abs=function(){var e=ct(this.value||"0");return e=this.genValue(e.abs().toString(),"number")},e.prototype.ceil=function(){var e=ct(this.value||"0");return e=e.ceil(),e=this.genValue(e.toString(),"number")},e.prototype.floor=function(){var e=ct(this.value||"0");return e=e.floor(),e=this.genValue(e.toString(),"number")},e.prototype.round=function(e){var t;return e>=0?(t=ct(this.value||"0"),t=t.toDecimalPlaces(e,4),t=this.genValue(t.toString(),"number")):t=this.genErrorValue(f(Xe.getLocale().MSG_EX_ROUND,e)),t},e.prototype.trunc=function(e){var t;return e>=0?(t=ct(this.value||"0"),t=t.toDecimalPlaces(e,1),t=this.genValue(t.toString(),"number")):t=this.genErrorValue(f(Xe.getLocale().MSG_EX_TRUNC,e)),t},e.prototype.cos=function(){var e=ct(this.value||"0");return e=e.cos(),e=this.genValue(e.toString(),"number")},e.prototype.exp=function(){var e=ct(this.value||"0");return e=e.exp(),e=this.genValue(e.toString(),"number")},e.prototype.ln=function(){var e=ct(this.value||"0");return e.greaterThan("0")?(e=e.ln(),e=this.genValue(e.toString(),"number")):e=this.genErrorValue(f(Xe.getLocale().MSG_EX_LN,e.toString())),e},e.prototype.log=function(e){var t=ct(this.value||"0");return t.greaterThan("0")&&e>0&&1!==e?(t=t.log(e),t=this.genValue(t.toString(),"number")):t=this.genErrorValue(f(Xe.getLocale().MSG_EX_LOG,e,t.toString())),t},e.prototype.power=function(e){var t=ct(this.value||"0");return t=t.pow(e),t=this.genValue(t.toString(),"number")},e.prototype.sin=function(){var e=ct(this.value||"0");return e=e.sin(),e=this.genValue(e.toString(),"number")},e.prototype.sqrt=function(){var e=ct(this.value||"0");return e=e.sqrt(),e=this.genValue(e.toString(),"number")},e.prototype.tan=function(){var e=ct(this.value||"0");return e=e.tan(),e=this.genValue(e.toString(),"number")},e}(),yt=function(){function e(){this.exprList=[]}return e.prototype.genValue=function(e,t,n,r,i){return new ft(this,e,t,n,r,i)},e.prototype.genErrorValue=function(e){return this.genValue(void 0,void 0,void 0,e,void 0)},e.prototype.genType=function(e,t,n,r,i,a){return new ht(this,e,t,n,r,i,a)},e.prototype.genErrorType=function(e){return this.genType(void 0,void 0,void 0,void 0,void 0,e)},e.prototype.getFunctionType=function(e,t,n,r){return this.doGetFunctionType(e,t,n,r)},e.prototype.getFunctionValue=function(e,t,n){return this.doGetFunctionValue(e,t,n)},e.prototype.getVariableType=function(e,t){return this.doGetVariableType(e,t)},e.prototype.getVariableValue=function(e,t){return this.doGetVariableValue(e,t)},e.prototype.getEntityType=function(e){return this.doGetEntityType(e)},e.prototype.getEntityValue=function(e,t){return this.doGetEntityValue(e,t)},e.prototype.getParserInfo=function(e){e=e.trim();for(var t=-1,n=0;n<this.exprList.length;n++)if(this.exprList[n].text===e){t=n;break}var r;if(t>=0)r=this.exprList[t].parser;else{r=(new pt).parser(e),this.exprList.push({parser:r,text:e})}return r},e.prototype.isIfNullToken=function(e){return h(e,this.doGetIfNullName())},e.prototype.isIIfToken=function(e){return h(e,this.doGetIIfName())},e.prototype.doGetIfNullName=function(){return""},e.prototype.doGetIIfName=function(){return""},e.prototype.doGetVariableType=function(e,t){},e.prototype.doGetVariableValue=function(e,t){},e.prototype.doGetFunctionType=function(e,t,n,r){},e.prototype.doGetFunctionValue=function(e,t,n){},e.prototype.doGetEntityType=function(e){},e.prototype.doGetEntityValue=function(e,t){},e}(),gt=function(){function e(){this.context=null,this.values={}}return e.prototype.genValue=function(e,t,n,r,i){return new ft(this.context,e,t,n,r,i)},e.prototype.genErrorValue=function(e){return this.genValue(void 0,void 0,void 0,e,void 0)},e.prototype.getValue=function(e){return this.values[e]},e.prototype.setValue=function(e,t){this.values[e]=t},e.prototype.calc=function(e,t){this.context=t||new yt;var n,r=this.context.getParserInfo(e);if(""===r.errorMsg){var i=this.doCalc(r.rootToken);""===i?(n=this.getValue(r.rootToken.id),n.tokens=r.tokens,n.rootToken=r.rootToken):n=this.genErrorValue(i)}else n=this.genErrorValue(r.errorMsg);return n},e.prototype.doCalc=function(e){var t,n,r,i,a=e,o=a.parent,u="",s=null;if(a.childs)for(var l=this.context.isIfNullToken(a),h=this.context.isIIfToken(a),c=0;c<a.childs.length&&""===(u=this.doCalc(a.childs[c]));c++)if(0===c){if(t=a.childs[0],r=this.getValue(t.id),l&&null!==r.toValue())break;if(h&&!r.toValue())c++;else if("TK_OR"===a.tokenType&&!0==!!r.toValue()||"TK_AND"===a.tokenType&&!1==!!r.toValue())break}else if(1===c&&(n=a.childs[1],i=this.getValue(n.id),h))break;if(""===u){switch(a.tokenType){case"TK_STRING":s=this.genValue(a.tokenValue,"string");break;case"TK_NUMBER":s=this.genValue(a.tokenValue,"number");break;case"TK_BOOL":s=this.genValue("true"===a.tokenValue,"boolean");break;case"TK_NULL":s=this.genValue(null,"null");break;case"TK_IDEN":s=this.genValue(a.tokenValue,"string"),p(a)&&(s=s.getVariableValue(null));break;case"TK_UNARY":s=r.negative(a.tokenValue);break;case"TK_NOT":s=r.not();break;case"TK_MULTI":s=r.multiply(i);break;case"TK_DIV":s=r.divide(i);break;case"TK_MOD":s=r.remainder(i);break;case"TK_PLUS":s=r.add(i);break;case"TK_MINUS":s=r.subtract(i);break;case"TK_CO":s=r.compare(i,a.tokenValue);break;case"TK_AND":s=r.and(i);break;case"TK_OR":s=r.or(i);break;case"TK_COLON":s=r.hashItem(i);break;case"TK_DOT":switch(n.tokenType){case"VTK_FUNCTION":s=i.getFunctionValue(r);break;case"TK_IDEN":s=i.getVariableValue(r)}break;case"VTK_COMMA":s=this.genValue([],"array");for(var f=0,y=a.childs;f<y.length;f++){var g=y[f];r=this.getValue(g.id),s.arrayPush(r)}break;case"VTK_PAREN":s=0===a.childs.length?this.genValue([],"array"):o&&"TK_IDEN"===o.tokenType&&"VTK_COMMA"!==t.tokenType?this.genValue([],"array").arrayPush(r):r;break;case"VTK_ARRAY":s=this.genValue([],"array"),a.childs.length>0&&("VTK_COMMA"===t.tokenType?s.arrayConcat(r):s.arrayPush(r));break;case"VTK_OBJECT":s=this.genValue({},"object"),a.childs.length>0&&("VTK_COMMA"===t.tokenType?s.objectSetProperties(r):s.objectSetProperty(r));break;case"VTK_SUBSCRIPT":s=r.subscript(i);break;case"VTK_FUNCTION":s=o&&"TK_DOT"===o.tokenType&&o.childs[0]!==a?r.hashItem(i):r.hashItem(i).getFunctionValue(null)}u=s.errorMsg,""===u&&this.setValue(a.id,s)}return u},e}(),dt=function(){function e(){this.context=null,this.types={}}return e.prototype.genType=function(e,t,n,r,i,a){return new ht(this.context,e,t,n,r,i,a)},e.prototype.genErrorType=function(e){return this.genType(void 0,void 0,void 0,void 0,void 0,e)},e.prototype.getType=function(e){return this.types[e]},e.prototype.setType=function(e,t){this.types[e]=t},e.prototype.check=function(e,t){var n=this;this.context=t||new yt;var r,i=this.context.getParserInfo(e);if(""===i.errorMsg){var a=this.doCheck(i.rootToken);if(""===a){r=this.getType(i.rootToken.id),r.tokens=i.tokens,r.rootToken=i.rootToken;var o=[],u=function(e){if("array"===T(e))for(var t=0,n=e;t<n.length;t++){var r=n[t];u(r)}else{for(var i=!1,a=0,s=o;a<s.length;a++){var r=s[a];if(i=r===e)break}i||o.push(e)}};c(r.rootToken,function(e){var t=n.getType(e.id);if(t){t.depends&&u(t.depends);var r=t.entity;if(r){var i=e.parent,a=i?n.getType(i.id):null;a&&a.entity||u(r.fullName)}}return!0},this),r.dependencies=o}else r=this.genErrorType(a)}else r=this.genErrorType(i.errorMsg);return r},e.prototype.doCheck=function(e){var t,n,r,i,a=e,o=a.parent,u="",s=null;if(a.childs)for(var l=0;l<a.childs.length&&""===(u=this.doCheck(a.childs[l]));l++)0===l?(t=a.childs[0],r=this.getType(t.id)):1===l&&(n=a.childs[1],i=this.getType(n.id));if(""===u){switch(a.tokenType){case"TK_STRING":s=this.genType("string","string",a.tokenValue);break;case"TK_NUMBER":s=this.genType("number","number",a.tokenValue);break;case"TK_BOOL":s=this.genType("boolean","boolean",a.tokenValue);break;case"TK_NULL":s=this.genType("null","null",a.tokenValue);break;case"TK_IDEN":s=this.genType("string","string",a.tokenValue),p(a)&&(s=s.getVariableType(null));break;case"TK_UNARY":s=r.negative(a.tokenValue);break;case"TK_NOT":s=r.not();break;case"TK_MULTI":s=r.multiply(i);break;case"TK_DIV":s=r.divide(i);break;case"TK_MOD":s=r.remainder(i);break;case"TK_PLUS":s=r.add(i);break;case"TK_MINUS":s=r.subtract(i);break;case"TK_CO":s=r.compare(i,a.tokenValue);break;case"TK_AND":s=r.and(i);break;case"TK_OR":s=r.or(i);break;case"TK_COLON":s=r.hashItem(i);break;case"TK_DOT":switch(n.tokenType){case"VTK_FUNCTION":s=i.getFunctionType(r);break;case"TK_IDEN":s=i.getVariableType(r)}break;case"VTK_COMMA":s=this.genType("array",[],[]);for(var h=0,c=a.childs;h<c.length;h++){var f=c[h];r=this.getType(f.id),s.arrayPush(r)}break;case"VTK_PAREN":s=0===a.childs.length?o&&"TK_IDEN"===o.tokenType?this.genType("array",[],[]):this.genType("undefined"):o&&"TK_IDEN"===o.tokenType&&"VTK_COMMA"!==t.tokenType?this.genType("array",[],[]).arrayPush(r):r;break;case"VTK_ARRAY":s=this.genType("array",[],[]),a.childs.length>0&&("VTK_COMMA"===t.tokenType?s.arrayConcat(r):s.arrayPush(r));break;case"VTK_OBJECT":s=this.genType("object",{},{}),a.childs.length>0&&("VTK_COMMA"===t.tokenType?s.objectSetProperties(r):s.objectSetProperty(r));break;case"VTK_SUBSCRIPT":s=r.subscript(i);break;case"VTK_FUNCTION":s=o&&"TK_DOT"===o.tokenType&&o.childs[0]!==a?r.hashItem(i):r.hashItem(i).getFunctionType(null)}u=s.errorMsg,""===u&&this.setType(a.id,s)}return u},e}(),_t=function(){function e(){this.curr=[]}return e.prototype.setDataCursor=function(e){this.dataCursor=e},e.prototype.push=function(e){this.curr.unshift({pIndex:0,params:e})},e.prototype.pop=function(){this.curr.shift()},e.prototype.isValid=function(e){return e>=0&&this.curr.length>0&&e<this.curr[0].params.length},e.prototype.isEntityData=function(e){if(this.curr.length>0){var t=this.curr[0];return t.pIndex=e||0,t.params[t.pIndex].isEntityData}return!1},e.prototype.getEntityName=function(e){return this.getData(e)||""},e.prototype.getEntityDataCursor=function(e,t){for(var n=e?this.dataCursor[e]:0,r=0;r<this.curr.length;r++){var i=this.curr[r];0===r&&(i.pIndex=t||0);var a=i.params[i.pIndex];if(a.isEntityData&&a.current===e){n=a.cursor;break}}return n},e.prototype.getData=function(e){var t;if(this.curr.length>0){var n=this.curr[0];n.pIndex=e||0,t=n.params[n.pIndex].current}return t},e}(),Tt=function(e){function t(){e.apply(this,arguments),this.exprContext=new _t,this.pageContext={$C:{}},this.contextVariables=[],this.functions={}}return n(t,e),t.prototype.setDataCursor=function(e){this.exprContext.setDataCursor(e)},t.prototype.setPageContext=function(e){this.pageContext.$C=e},t.prototype.setDataContext=function(e){this.dataContext=e},t.prototype.setData=function(e){this.data=e},t.prototype.addFunction=function(e){var t;t={},t[""]=e._||{},t.array=e.array||{},t.boolean=e.boolean||{},t.date=e.date||{},t.number=e.number||{},t.object=e.object||{},t.string=e.string||{};for(var n in t)if(t.hasOwnProperty(n)){var r=t[n];for(var i in r)if(r.hasOwnProperty(i)){var a=n?n+"."+i:i;r[i].getLocale=function(e){return function(){return Xe.getFunction()[e]}}(a)}}return E(this.functions,t)},t.prototype.getFunction=function(){return this.functions},t.prototype.doGetIfNullName=function(){return"IfNull"},t.prototype.doGetIIfName=function(){return"IIf"},t.prototype.doGetFunctionType=function(e,t,n,r){var i,a;a=null!==t?t.entity?t.entity.type:t.type:"";var o=this.getFuncType(a,e,n);if(null===o)i=this.genErrorType(f(Xe.getLocale().MSG_EC_FUNC_T,a,e));else{var u=[];if(o.p)for(var s=r,l=0;l<o.p.length;l++)if("expr"===o.p[l]&&"string"===n[l]&&"string"===T(s[l])){var p=void 0;if(p=t&&t.entity?this.calcEntityDependencies(s[l],t.entity.fullName):this.calcEntityDependencies(s[l]),""!==p.errorMsg){i=this.genErrorType(p.errorMsg);break}u=u.concat(p.dependencies)}if(!i){var h=null,c=void 0;switch(o.e){case"root":h="",c="object";break;case"parent":null===t?(h=this.getParentName(this.exprContext.getEntityName()),c="object"):t.entity?(h=this.getParentName(t.entity.fullName),c="object"):i=this.genErrorType(f(Xe.getLocale().MSG_EC_FUNC_E,"Parent"));break;case"data":case"value":var y=null;null===t?y=this.exprContext.getEntityName():t.entity&&(y=t.entity.fullName),null!==y&&("data"===o.e&&(h=y),u.push(y))}i||(null!==h&&(h=this.genEntityInfo(h,c)),0===u.length&&(u=null),i=this.genType(o.r,o.r,void 0,h,u))}}return i},t.prototype.doGetFunctionValue=function(e,t,n){var r;r=null!==t?t.entity?t.entity.type:t.type:"";for(var i=[t].concat(n),a=[],o=0,u=n;o<u.length;o++){var s=u[o];a.push(T(s))}var l=this.getFunc(r,e,a);return l?l.fn.apply(this,[this].concat(i)):this.genErrorValue(f(Xe.getLocale().MSG_EC_FUNC_P,r,e))},t.prototype.doGetVariableType=function(e,t){var n,r;if(r=0,null===t&&"$"===e.split("")[0]&&(r=e.substr(1),"C"===r?n=this.genType(T(this.pageContext.$C)):(r=Number(r),isNaN(r)?n=this.genErrorType(f(Xe.getLocale().MSG_EC_VARI_I,e)):this.exprContext.isValid(r)?e="":n=this.genErrorType(f(Xe.getLocale().MSG_EC_VARI_N,e)))),!n)if(this.exprContext.isEntityData(r)){var i=void 0,a=void 0;null===t?(i=this.genEntityInfo(this.getPropertyName(this.exprContext.getEntityName(r),e)),i?a=i.type:n=this.genErrorType(f(Xe.getLocale().MSG_EC_PROP_N,e))):t.entity?(i=this.genEntityInfo(this.getPropertyName(t.entity.fullName,e)),i?a=i.type:"object"===t.entity.type&&""!==t.entity.field?a="undefined":n=this.genErrorType(f(Xe.getLocale().MSG_EC_PROP_N,e))):(i=null,a="undefined"),n||(n=this.genType(a,a,e,i))}else n=this.genType();return n},t.prototype.doGetVariableValue=function(e,t){var n,r;if(r=0,null===t&&"$"===e.split("")[0]&&(r=e.substr(1),"C"===r?n=this.genValue(this.pageContext.$C):(r=Number(r),isNaN(r)?n=this.genErrorValue(f(Xe.getLocale().MSG_EC_VARI_I,e)):this.exprContext.isValid(r)?e="":n=this.genErrorValue(f(Xe.getLocale().MSG_EC_VARI_N,e)))),!n){var i=void 0;if(this.exprContext.isEntityData(r)){var a=void 0,o=void 0;if(null===t?(a=this.genEntityInfo(this.getPropertyName(this.exprContext.getEntityName(r),e)),a?i=""!==a.field||""===e?this.getEntityData(a.name,r):this.getEntityData(this.getParentName(a.name),r):n=this.genErrorValue(f(Xe.getLocale().MSG_EC_PROP_N,e)),o=null):(i=t.toValue(),!t.entity||"object"===t.entity.type&&""!==t.entity.field?a=null:(a=this.genEntityInfo(this.getPropertyName(t.entity.fullName,e)),a?""===a.field&&(o=t):n=this.genErrorValue(f(Xe.getLocale().MSG_EC_PROP_N,e)))),!n)if(i){if(null===t&&""===e||(i=i[e]),void 0===i&&(i=null,a&&("object"===a.type?i={}:"array"===a.type&&(i=[]))),(n=this.genValue(i,null,a,"",o))&&"array"===n.type&&n.entity){n.entity.map=[];for(var u=0;u<i.length;u++)n.entity.map.push(u)}}else n=this.genErrorValue(f(Xe.getLocale().MSG_EC_PROP_E,i,e))}else{if(i=null===t?this.getData(r):t.toValue(),null!==t||""!==e)switch(T(i)){case"object":case"array":case"string":i=i[e];break;default:n=this.genErrorValue(f(Xe.getLocale().MSG_EC_PROP_E,i,e))}n||(n=this.genValue(i))}}return n},t.prototype.doGetEntityType=function(e){var t=this.genEntityInfo(e.entity,"object");return this.genType("object","object",void 0,t,[t.fullName])},t.prototype.doGetEntityValue=function(e,t){var n=e.toValue()[t],r=this.genEntityInfo(e.entity,"object");r.recNo=e.entity.map[t];var i=e.parentObj;return this.genValue(n,T(n),r,"",i)},t.prototype.genEntityInfo=function(e,t){"object"===T(e)&&(e=e.fullName);var n,r=[],i=[];if(""!==e){var a=e.split("."),o=a[0],u=this.dataContext,s=u[o];if(s){r.push(o);for(var l=1;l<a.length;l++)if(o=a[l],s.childs&&s.childs[o]&&0===i.length)r.push(o),s=s.childs[o];else{var p=i.join(".");if(""!==p&&(p+="."),p+=o,!s.fields||!s.fields[p])break;i.push(o),n=s.fields[p].type}}}var h={field:i.join("."),fullName:e,name:r.join("."),recNo:-1,type:n};return h.name===h.fullName?h.type="array":h.name+"."+h.field!==h.fullName&&(h=null),h&&t&&(h.type=t),h},t.prototype.getRootValue=function(){var e=this.genEntityInfo("","object");return e.recNo=0,this.genValue(this.data,"object",e,"")},t.prototype.getParentValue=function(e){var t;if(this.exprContext.isEntityData()){var n=void 0;if(null===e?n=this.exprContext.getEntityName():e.entity&&""===e.entity.field?e.parentObj?t=e.parentObj:n=e.entity.fullName:t=this.genErrorValue(f(Xe.getLocale().MSG_EC_FUNC_E,"Parent")),!t){n=this.genEntityInfo(this.getParentName(n),"object"),n.recNo=this.exprContext.getEntityDataCursor(n.name);var r=this.getEntityData(n.name);t=this.genValue(r,"",n)}}else t=this.genValue(null);return t},t.prototype.getEntityData=function(e,t){var n=this.data;if(""!==e)for(var r=e.split("."),i=[],a=0,o=r;a<o.length;a++){var u=o[a];i.push(u),n=n[u];var s=this.exprContext.getEntityDataCursor(i.join("."),t);if(void 0===(n=n[s]))break}return n},t.prototype.getData=function(e){return this.exprContext.getData(e)},t.prototype.getParentName=function(e){var t,n=e.split(".");return n.length>0?(n.pop(),t=n.join(".")):t="",t},t.prototype.getPropertyName=function(e,t){return e&&t?e+"."+t:e||t},t.prototype.getRecNo=function(e){var t;if(this.exprContext.isEntityData()){var n=void 0;if(null===e){n=this.exprContext.getEntityName();var r=this.exprContext.getEntityDataCursor(n);t=this.genValue(r)}else t=e.entity&&""===e.entity.field?this.genValue(e.entity.recNo):this.genErrorValue(f(Xe.getLocale().MSG_EC_FUNC_E,"RecNo"))}else t=this.genValue(-1);return t},t.prototype.setFieldName=function(e){this.fieldName=e},t.prototype.getFieldName=function(){return this.fieldName||""},t.prototype.setFieldDisplayName=function(e){this.fieldDisplayName=e},t.prototype.getFieldDisplayName=function(){return this.fieldDisplayName||""},t.prototype.setFieldValue=function(e){this.fieldValue=e},t.prototype.getFieldValue=function(){return this.fieldValue||null},t.prototype.findParams=function(e,t){for(var n=[],r=[],i=e.length,a=0;a<e.length;a++){var o=e[a];o.indexOf("?")===o.length-1&&(o=o.replace("?",""),i--),r.push(o),a<t.length&&n.push(o)}var u=t.length>=i&&t.length<=r.length;if(u)for(var s=0;s<n.length&&(u="undefined"===n[s]||"undefined"===t[s]||"null"===t[s]||n[s]===t[s]||"expr"===n[s]&&"string"===t[s]||"array"===n[s]&&n[s]===T(t[s])||"object"===n[s]&&n[s]===T(t[s]));s++);return u||(n=null),n},t.prototype.getFunc=function(e,t,n){var r;if("undefined"===e){var i=void 0,a=[];for(var o in this.functions)this.functions.hasOwnProperty(o)&&(i=this.functions[o][t])&&null!==this.findParams(i.p,n)&&a.push(i);r=a.length>1?a:1===a.length?a[0]:null}else(r=this.functions[e][t])&&r.fn&&null!==this.findParams(r.p,n)||(r=null);return r},t.prototype.getFuncType=function(e,t,n){var r=null,i=this.getFunc(e,t,n);if("array"===T(i)){for(var a="",o=0,u=i;o<u.length;o++){var s=u[o];if(null===r)a=s.r;else if(s.r!==e){a="undefined";break}}""!==a&&(r={r:a})}else null!==i&&(r={e:i.e,p:this.findParams(i.p,n),r:i.r});return r},t.prototype.getContextVariableValue=function(e){var t,n=this.contextVariables;return n.length>0&&(t=n[n.length-1][e]),void 0===t&&(t=null),this.genValue(t)},t.prototype.pushContextVariables=function(e){this.contextVariables.push(e)},t.prototype.popContextVariables=function(){this.contextVariables.pop()},t.prototype._calcExpr=function(e,t){t.length>0&&this.exprContext.push(t);var n=new gt,r=n.calc(e,this);return t.length>0&&this.exprContext.pop(),r},t.prototype.calcEntityExpr=function(e,t,n){for(var r=[],i=1;i<arguments.length;)r.push({current:arguments[i],cursor:arguments[i+1],isEntityData:!0}),i+=2;return this._calcExpr(e,r)},t.prototype.calcDataExpr=function(e,t){for(var n=[],r=1;r<arguments.length;)n.push({current:arguments[r],isEntityData:!1}),r++;return this._calcExpr(e,n)},t.prototype.calcDependencies=function(e,t){t.length>0&&this.exprContext.push(t);var n=new dt,r=n.check(e,this);return t.length>0&&this.exprContext.pop(),r},t.prototype.calcEntityDependencies=function(e,t){for(var n=[],r=1;r<arguments.length;)n.push({current:arguments[r],isEntityData:!0}),r++;return this.calcDependencies(e,n)},t.prototype.calcDataDependencies=function(e){for(var t=[],n=1;n<arguments.length;)t.push({isEntityData:!1}),n++;return this.calcDependencies(e,t)},t.prototype.pushEntityCurrent=function(e,t){this.exprContext.push([{current:e,cursor:t,isEntityData:!0}])},t.prototype.popEntityCurrent=function(){this.exprContext.pop()},t}(yt),bt=function(){function e(){this.list=[],this.cache={},this.sorted=!1}return e.prototype._getExprs=function(e,t,n){var r=t?e+"."+t:e,i="L"===n||"A"===n,a=r+"|"+n,o=this.sorted?this.cache[a]:[];if(!o){o=[];for(var u={},s={},l=[],p=0,h=this.list;p<h.length;p++){var c=h[p];c.types?c.types.indexOf(n)>=0&&l.push(c):l.push(c)}var f=function(e,t){for(var n=0;n<l.length;n++)if(!0!==s[n]){s[n]=!0;var r=l[n],a=i&&r.entityName===t&&""!==r.entityName;if(!a&&r.dependencies)for(var o=0,p=r.dependencies;o<p.length;o++){var h=p[o];if(a=h===e)break}a&&!u[n]&&(u[n]=!0,f(r.fullName,t)),s[n]=!1}};f(r,r);for(var y=0;y<l.length;y++)if(u[y]){var g={};for(var d in l[y])l[y].hasOwnProperty(d)&&(g[d]=l[y][d]);o.push(g)}this._doUpdateMode(o,n,r,e,t),this.cache[a]=o}return o},e.prototype._doUpdateMode=function(e,t,n,r,i){for(var a=[{entityName:r,fullName:n,propertyName:i,type:t,updateMode:"Single",updateTarget:""}],o=0,u=e;o<u.length;o++){var s=u[o];this._doGetMode(a,s),a.push({entityName:s.entityName,fullName:s.fullName,propertyName:s.propertyName,type:"U",updateMode:s.updateMode,updateTarget:s.updateTarget})}},e.prototype._doGetMode=function(e,t){var n=[];if(e&&t&&t.dependencies)for(var r=0;r<e.length;r++)for(var i=e[r],a=0;a<t.dependencies.length;a++)if(i.fullName===t.dependencies[a]){var o=!0,u=!1;if("U"===i.type){for(var s=!1,l=0;l<t.dependencies.length&&!(s=0===i.fullName.indexOf(t.dependencies[l]+"."));l++);i.entityName===t.entityName?s?n.push({updateMode:"All"}):n.push({updateMode:"Single"}):0===t.entityName.indexOf(i.entityName+".")?s?n.push({updateMode:"All"}):n.push({updateMode:"BranchUpdate",updateTarget:this._doGetUpdateTarget(i.entityName,t.entityName)}):0===i.entityName.indexOf(t.entityName+".")?(n.push({updateMode:"Single"}),u=!0):(n.push({updateMode:"All"}),o=!1)}else"R"===i.type?i.entityName===t.entityName?n.push({updateMode:"All"}):0===t.entityName.indexOf(i.entityName+".")?n.push({updateMode:"BranchDelete",updateTarget:this._doGetUpdateTarget(i.entityName,t.entityName)}):0===i.entityName.indexOf(t.entityName+".")?(n.push({updateMode:"Single"}),u=!0):(n.push({updateMode:"All"}),o=!1):i.entityName===t.entityName?n.push({updateMode:"All"}):0===t.entityName.indexOf(i.entityName+".")?n.push({updateMode:"All"}):0===i.entityName.indexOf(t.entityName+".")?(n.push({updateMode:"Single"}),u=!0):(n.push({updateMode:"All"}),o=!1);o&&!u&&n.push({updateMode:i.updateMode,updateTarget:i.updateTarget})}for(var p,h,c="Single",f="",y=0,g=n;y<g.length;y++){var d=g[y];p=d.updateMode,h=d.updateTarget||"",c!==p||"BranchDelete"!==c&&"BranchUpdate"!==c?"BranchDelete"===p||"Single"===c?(c=p,f=h):"BranchDelete"===c||"Single"===p||"All"===p&&(c=p,f=h):f.length>h.length&&(f=h)}t.updateMode=c,t.updateTarget=f},e.prototype._doGetUpdateTarget=function(e,t){var n=e.split("."),r=t.split(".");return n.push(r[n.length]),n.join(".")},e.prototype.reset=function(){this.list=[],this.cache={},this.sorted=!1},e.prototype.add=function(e,t,n,r,i,a){this.cache={},this.sorted=!1;for(var o=-1,u=0;u<this.list.length;u++){var s=this.list[u];if(s.expr===e&&s.entityName===t&&s.propertyName===n&&s.types===r&&s.callback===i&&s.scope===a){o=u;break}}-1===o&&this.list.push({callback:i,entityName:t||"",expr:e||"",fullName:n?t+"."+n:t||"",propertyName:n||"",scope:a,types:r})},e.prototype.remove=function(e,t,n,r,i,a){this.cache={},this.sorted=!1;for(var o=0;o<this.list.length;o++){var u=this.list[o];if(u.expr===e&&u.entityName===t&&u.propertyName===n&&u.types===r&&u.callback===i&&u.scope===a){this.list.splice(o,1);break}}},e.prototype.checkAndSort=function(e){this.cache={},this.sorted=!0;for(var t="",n=0,r=this.list;n<r.length;n++){var i=r[n];if(!i.dependencies&&e){var a=e(i.expr,i.entityName);if(""!==(t=a.errorMsg)){t=f(Xe.getLocale().MSG_ES_PARSER,i.entityName,i.expr,t);break}i.dependencies=a.dependencies}}if(""===t){for(var o=[],u=[],s=function(e,t){for(var n=!1,r=0,i=e;r<i.length;r++){i[r]===t&&(n=!0)}return n},l=function(e,t){if(!s(t,e)){for(var n=0,r=o;n<r.length;n++){var i=r[n],a=!1;if(e&&e.dependencies)for(var p=0,h=e.dependencies;p<h.length;p++){var c=h[p];if(a=i.fullName===c)break}a&&(t.push(e),l(i,t))}s(u,e)||u.push(e)}},p=0,h=this.list;p<h.length;p++){var i=h[p];""!==i.fullName&&o.push(i)}for(var c=0,y=o;c<y.length;c++){var g=y[c];l(g,[])}for(var d=0,_=this.list;d<_.length;d++){var i=_[d];""===i.fullName&&u.push(i)}this.list=u}return t},e.prototype.getExprsByUpdate=function(e,t){return this._getExprs(e,t,"U")},e.prototype.getExprsByLoad=function(e){return this._getExprs(e,"","L")},e.prototype.getExprsByAdd=function(e){return this._getExprs(e,"","A")},e.prototype.getExprsByRemove=function(e){return this._getExprs(e,"","R")},e}();return Xe.defineLocale("zh-cn",{MSG_EC_FUNC_E:"只有实体对象才可以调用 {0} 方法",MSG_EC_FUNC_P:"{0} 没有名称为 {1} 的方法或参数不匹配",MSG_EC_FUNC_T:"{0} 没有与名称为 {1} 的相匹配的方法",MSG_EC_PROP_E:"{0} 无法获取属性: {1}",MSG_EC_PROP_N:"属性不存在: {0}",MSG_EC_VARI_I:"参数索引不存在: {0}",MSG_EC_VARI_N:"参数不存在: {0}",MSG_EF_MODEL:'"{0}" 不是合法的匹配模式',MSG_EL_SYNTAX_ON:"{0} 不是合法的八进制数",MSG_EL_SYNTAX_S:"{0} 引号不匹配",
MSG_EL_SYNTAX_UC:"{0} 不是合法的unicode字符",MSG_EL_SYNTAX_XN:"{0} 不是合法的十六进制数",MSG_EP_EMPTY:"表达式不能为空",MSG_EP_LEXICAL_B:"{0} 无法作为表达式的开头",MSG_EP_LEXICAL_E:"{0} 无法作为表达式的结尾",MSG_EP_LEXICAL_L:"{0} 后不允许出现 {1}",MSG_EP_MATCH:"{0} 不匹配",MSG_EP_SYNTAX_A:"数组中不允许使用 {0} 操作符",MSG_EP_SYNTAX_C:"{0} 操作符必须存在于{}、[]、()中",MSG_EP_SYNTAX_D:"{0} 无法做属性访问操作",MSG_EP_SYNTAX_E:"{0} 前不允许表达式存在",MSG_EP_SYNTAX_M:'{0} 在不是函数参数列表时不允许出现","分隔符',MSG_EP_SYNTAX_N:"该处 {0} 无意义",MSG_EP_SYNTAX_O:"对象书写格式不正确",MSG_EP_SYNTAX_P:"{0} 操作符必须存在于{}中",MSG_EP_SYNTAX_SUB:"[]用作下标访问时不允许出现 {0} 分隔符",MSG_EP_UNKNOWN:"无法识别 {0}",MSG_ES_PARSER:"作用于实体“{0}”上的表达式“{1}”解析出错：{2}",MSG_EX_ADD:"{0} 和 {1} 无法做加法运算",MSG_EX_AND:"{0} 和 {1} 无法做逻辑与运算",MSG_EX_AND_L:"{0} 无法做逻辑与运算的左运算数",MSG_EX_COMPARE_A:"{0} 和 {1} 无法做大于运算",MSG_EX_COMPARE_B:"{0} 和 {1} 无法做小于运算",MSG_EX_COMPARE_C:"{0} 和 {1} 无法做大于等于运算",MSG_EX_COMPARE_D:"{0} 和 {1} 无法做小于等于运算",MSG_EX_DIVIDE:"{0} 和 {1} 无法做除法运算",MSG_EX_DIVIDE_N:"{0} 不能作为除数使用",MSG_EX_DOT:"{0} 无法做属性访问操作",MSG_EX_EQUAL:"{0} 和 {1} 无法做相等运算",MSG_EX_EQUAL_N:"{0} 和 {1} 无法做不等运算",MSG_EX_FUNC_NULL:"null 不能调用 {0} 方法",MSG_EX_LN:"{0} 无法做自然对数运算",MSG_EX_LOG:"无法做以 {0} 为底 {1} 的对数运算",MSG_EX_MULTIPLY:"{0} 和 {1} 无法做乘法运算",MSG_EX_NEGATIVE:"{0} 无法做一元负数运算",MSG_EX_OR:"{0} 和 {1} 无法做逻辑或运算",MSG_EX_OR_L:"{0} 无法做逻辑或运算的左运算数",MSG_EX_POSITIVE:"{0} 无法做一元正数运算",MSG_EX_REMAINDER:"{0} 和 {1} 无法做余数运算",MSG_EX_REMAINDER_N:"{0} 不能作为除数使用",MSG_EX_ROUND:"做四舍五入运算时，保留小数位数不能为负数: {0}",MSG_EX_SUBSCRIPT:"{0} 无法做下标操作",MSG_EX_SUBSCRIPT_T:"下标必须为数字: {0}",MSG_EX_SUBSCRIPT_U:"{0} 下标越界: {1}",MSG_EX_SUBTRACT:"{0} 和 {1} 无法做减法运算",MSG_EX_TRUNC:"做截断运算时，保留小数位数不能为负数: {0}"}),Xe.defineFunction("zh-cn",{FieldDisplayName:{fn:"获取当前字段别名",p:[],r:"字段别名（显示名称）"},FieldName:{fn:"获取当前字段唯一标识",p:[],r:"字段唯一标识"},FieldValue:{fn:"获取当前字段值",p:[],r:"字段值"},IIf:{fn:"条件判断函数，如果第一个参数为true，则获取第二个参数，否则获取第三个参数",p:["条件值","真值","假值"],r:"第二个参数或第三个参数"},IfNull:{fn:"空值判断函数，如果第一个参数为null，则获取第二个参数，否则获取第一个参数",p:["值","默认值"],r:"第一个参数或第二个参数"},Now:{fn:"获取本地当前日期时间",p:[],r:"本地当前日期时间"},Parent:{fn:"获取当前实体的父实体对象，如果当前为根则获取自己",p:[],r:"父实体对象"},PropValue:{fn:"获取对象属性值",p:["对象或数组(没有分隔符则获取数组第一个元素，有分隔符获取数组所有元素集合)","属性名","分隔符?"],r:"属性值"},Random:{fn:"返回介于 0 ~ 1 之间的一个随机数",p:[],r:"数字"},RecNo:{fn:"获取当前实体的索引号，没有记录返回-1",p:[],r:"索引号"},Root:{fn:"获取实体根对象",p:[],r:"实体根对象"},"array.Average":{fn:"获取集合元素的平均值",p:["表达式?"],r:"平均值"},"array.Count":{fn:"获取集合元素个数",p:[],r:"个数"},"array.Distinct":{fn:"获取集合中唯一元素的集合",p:["表达式?"],r:"集合"},"array.Max":{fn:"获取集合元素的最大值",p:["表达式?"],r:"最大值"},"array.Min":{fn:"获取集合元素的最小值",p:["表达式?"],r:"最小值"},"array.Sum":{fn:"获取集合元素的合计值",p:["表达式?"],r:"合计值"},"array.Where":{fn:"获取满足条件的元素集合",p:["条件表达式"],r:"集合"},"boolean.ToString":{fn:"转换布尔类型为字符串",p:[],r:"字符串"},"date.DateOf":{fn:"获取 Date 对象的日期部分",p:[],r:"日期"},"date.DayOf":{fn:"从 Date 对象获取一个月中的某一天（1 ~ 31）",p:[],r:"日"},"date.DayOfWeek":{fn:"得到一周中的星期几（0 ~ 6）",p:[],r:"周"},"date.DaysBetween":{fn:"获取日期差",p:["结束日期时间"],r:"日差"},"date.HourOf":{fn:"从 Date 对象获取一天中的第几个小时",p:[],r:"时"},"date.HoursBetween":{fn:"获取小时差",p:["结束日期时间"],r:"时差"},"date.IncDay":{fn:"增加指定的天数",p:["天数"],r:"日期时间"},"date.IncHour":{fn:"增加指定的小时数",p:["小时数"],r:"日期时间"},"date.IncMinute":{fn:"增加指定的分钟数",p:["分钟数"],r:"日期时间"},"date.IncMonth":{fn:"增加指定的月数",p:["月数"],r:"日期时间"},"date.IncSecond":{fn:"增加指定的秒数",p:["秒数"],r:"日期时间"},"date.IncWeek":{fn:"增加指定的周数",p:["周数"],r:"日期时间"},"date.IncYear":{fn:"增加指定的年数",p:["年数"],r:"日期时间"},"date.MilliSecondOf":{fn:"从 Date 对象获取毫秒",p:[],r:"毫秒"},"date.MilliSecondsBetween":{fn:"获取毫秒差",p:["结束日期时间"],r:"毫秒差"},"date.MinuteOf":{fn:"从 Date 对象获取分钟（0 ~ 59）",p:[],r:"分"},"date.MinutesBetween":{fn:"获取分钟差",p:["结束日期时间"],r:"分差"},"date.MonthOf":{fn:"从 Date 对象获取月份（1 ~ 12）",p:[],r:"月"},"date.MonthsBetween":{fn:"获取月份差",p:["结束日期时间"],r:"月差"},"date.SecondOf":{fn:"从 Date 对象获取秒数（0 ~ 59）",p:[],r:"秒"},"date.SecondsBetween":{fn:"获取秒差",p:["结束日期时间"],r:"秒差"},"date.ToString":{fn:"转换日期时间类型为字符串",p:["日期时间格式?"],r:"字符串"},"date.WeekOf":{fn:"从 Date 对象获取一年中的第几周（1 ~ 53）",p:[],r:"周"},"date.WeeksBetween":{fn:"获取周差",p:["结束日期时间"],r:"周差"},"date.YearOf":{fn:"从 Date 对象获取年份",p:[],r:"年"},"date.YearsBetween":{fn:"获取年差",p:["结束日期时间"],r:"年差"},"number.Abs":{fn:"获取数的绝对值",p:[],r:"绝对值"},"number.Ceil":{fn:"对数进行向上取整",p:[],r:"数值"},"number.Cos":{fn:"获取数的余弦",p:[],r:"余弦"},"number.Exp":{fn:"获取 e 的指数",p:[],r:"指数"},"number.Floor":{fn:"对数进行向下取整",p:[],r:"数值"},"number.Ln":{fn:"获取数的自然对数（底为 e）",p:[],r:"自然对数"},"number.Log":{fn:"获取数的指定底数的对数",p:["底数"],r:"对数"},"number.Power":{fn:"获取数的指定指数的次幂",p:["指数"],r:"次幂"},"number.Round":{fn:"根据保留的小数位数对数四舍五入",p:["保留小数位数"],r:"数值"},"number.Sin":{fn:"获取数的正弦",p:[],r:"正弦"},"number.Sqrt":{fn:"获取数的平方根",p:[],r:"平方根"},"number.Tan":{fn:"获取树的正切值",p:[],r:"正切值"},"number.ToRMB":{fn:"获取人民币大写",p:["是否人民币(默认true)?","是否大写(默认true)?"],r:"人民币大写"},"number.ToString":{fn:"转换数字类型为字符串",p:[],r:"字符串"},"number.Trunc":{fn:"根据保留的小数位数对数进行截断",p:["保留小数位数"],r:"数值"},"object.Parent":{fn:"获取父实体对象，如果当前为根则获取自己",p:[],r:"父实体对象"},"object.RecNo":{fn:"获取当前实体的索引号，没有实体返回-1",p:[],r:"索引号"},"string.LeftString":{fn:"获取字符串的左子字符串，指定长度",p:["长度"],r:"子字符串"},"string.Length":{fn:"获取字符串长度",p:[],r:"字符串长度"},"string.Lower":{fn:"转换字符串为小写",p:[],r:"小写字符串"},"string.Pos":{fn:"检索字符串，获取子字符串在字符串中的起始位置",p:["子字符串"],r:"位置索引"},"string.Replace":{fn:"字符串替换",p:["被搜索的子字符串","用于替换的子字符串","匹配模式?"],r:"替换后的新字符串"},"string.ReplaceReg":{fn:"正则替换",p:["用于匹配子字符串的正则表达式","用于替换的子字符串","匹配模式?"],r:"替换后的新字符串"},"string.RightString":{fn:"获取字符串的右子字符串，指定长度",p:["长度"],r:"子字符串"},"string.SubString":{fn:"获取字符串的子字符串，指定开始位置和长度",p:["开始位置","长度"],r:"子字符串"},"string.ToDate":{fn:"转换字符串类型为日期时间",p:["日期时间格式?"],r:"日期时间"},"string.ToNumber":{fn:"转换字符串类型为数字",p:[],r:"数字"},"string.ToString":{fn:"转换字符串类型为字符串",p:[],r:"字符串"},"string.Trim":{fn:"去除字符串两端空格",p:[],r:"字符串"},"string.TrimLeft":{fn:"去除字符串左端空格",p:[],r:"字符串"},"string.TrimRight":{fn:"去除字符串右端空格",p:[],r:"字符串"},"string.Upper":{fn:"转换字符串为大写",p:[],r:"大写字符串"}}),function(){function e(){this.exprContext=new Tt,this.exprList=new bt,this.addFunction(rt)}return e.prototype.addFunction=function(e){return this.exprContext.addFunction(e)},e.prototype.getFunction=function(){return this.exprContext.getFunction()},e.prototype.getExpressionList=function(){return this.exprList},e.prototype.checkAndSort=function(){return this.exprList.checkAndSort(function(e){return function(t,n){return e.calcEntityDependencies(t,n)}}(this.exprContext))},e.prototype.addExpression=function(e,t,n,r,i,a){return this.exprList.add(e,t,n,r,i,a),this},e.prototype.removeExpression=function(e,t,n,r,i,a){return this.exprList.remove(e,t,n,r,i,a),this},e.prototype.resetExpression=function(){return this.exprList.reset(),this},e.prototype.calcExpression=function(e,t){var n;switch(e){case"load":n=this.exprList.getExprsByLoad(t.entityName);break;case"add":n=this.exprList.getExprsByAdd(t.entityName);break;case"update":n=this.exprList.getExprsByUpdate(t.entityName,t.propertyName);break;case"remove":n=this.exprList.getExprsByRemove(t.entityName)}for(var r=0,i=n;r<i.length;r++){var a=i[r];t.exprInfo=a,a.callback.call(a.scope,e,t)}return this},e.prototype.init=function(e,t,n){return this.exprContext.setData(e),this.exprContext.setDataContext(t),this.exprContext.setPageContext(n||{}),this},e.prototype.calcDependencies=function(e,t){return this.exprContext.calcEntityDependencies(e,t)},e.prototype.calcExpr=function(e,t,n,r){this.exprContext.setDataCursor(n),r&&this.exprContext.pushContextVariables(r);var i=this.exprContext.calcEntityExpr(e,t,n[t]);return r&&this.exprContext.popContextVariables(),i},e.prototype.calc=function(e,t){return this.exprContext.calcDataExpr(e,t)},e}()});
